I"¥#<h1 id="è½¯ä»¶å®‰è£…">è½¯ä»¶å®‰è£…</h1>
<p>ä¸‹è½½arduinoï¼š</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt <span class="nb">install </span>arduino
</code></pre></div></div>

<p>å®‰è£…rosserialï¼š</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt <span class="nb">install </span>ros-melodic-rosserial ros-melodic-rosserial-server ros-melodic-rosserial-arduino ros-melodic-rosserial-python
</code></pre></div></div>

<p>ä¸ºäº†åœ¨Arduinoä¸­ä½¿ç”¨å®ƒ,éœ€è¦åˆ›å»ºä¸€ä¸ªç”¨äºArduinoçš„rosserialåº“ï¼š</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> ~/Arduino/libraries/
<span class="nb">rm</span> <span class="nt">-rf</span> ros_lib
rosrun rosserial_arduino make_libraries.py <span class="nb">.</span>
</code></pre></div></div>

<h1 id="arduino">arduino</h1>
<h2 id="subscriber">subscriber</h2>
<p>arduinoæ¥å—å‘å¸ƒåœ¨/led_outçš„æ•°æ®ï¼Œæ§åˆ¶pin8å¼•è„šçš„ç”µå¹³å¼€å…³ã€‚</p>
<h3 id="ç¡¬ä»¶">ç¡¬ä»¶</h3>
<p>ä½¿ç”¨çš„æ˜¯arduino pro mini 328pç‰ˆï¼Œå‘ç°168pç‰ˆæœ¬å­˜å‚¨ä¸å¤Ÿã€‚</p>

<p><img src="/imgs/ç”µå­/arduino/arduino-rosserial/1.png" alt="ros_sub" /></p>

<blockquote>
  <p>DTRç”¨äºåœ¨ä¸Šä¼ ç¨‹åºæ—¶è‡ªåŠ¨RESETæ¿å­ï¼Œå¦åˆ™éœ€è¦åœ¨ä¸Šä¼ æ—¶æ‰‹åŠ¨æŒ‰ä¸€ä¸‹æ¿å­ä¸Šçš„RESETæŒ‰é”®ï¼ˆæ—¶æœºéœ€è¦è‡ªå·±æŠŠæ¡ï¼Œæ¯”è¾ƒéº»çƒ¦ï¼‰ã€‚</p>
</blockquote>

<h3 id="ä»£ç ">ä»£ç </h3>
<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;ros.h&gt;
#include &lt;std_msgs/Byte.h&gt;
</span>
<span class="kt">void</span> <span class="nf">process</span><span class="p">(</span><span class="k">const</span> <span class="n">std_msgs</span><span class="o">::</span><span class="n">Byte</span><span class="o">&amp;</span> <span class="n">led_msg</span><span class="p">){</span>
  <span class="n">digitalWrite</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">led_msg</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">ros</span><span class="o">::</span><span class="n">NodeHandle</span> <span class="n">nh</span><span class="p">;</span>
<span class="n">ros</span><span class="o">::</span><span class="n">Subscriber</span><span class="o">&lt;</span><span class="n">std_msgs</span><span class="o">::</span><span class="n">Byte</span><span class="o">&gt;</span> <span class="n">sub</span><span class="p">(</span><span class="s">"led_out"</span><span class="p">,</span> <span class="n">process</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// put your setup code here, to run once:</span>
  <span class="n">pinMode</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>

  <span class="n">nh</span><span class="p">.</span><span class="n">initNode</span><span class="p">();</span>
  <span class="n">nh</span><span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">sub</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">loop</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// put your main code here, to run repeatedly:</span>
  <span class="n">nh</span><span class="p">.</span><span class="n">spinOnce</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<blockquote>
  <p>arduinoä¸Šä¼ ç¨‹åºéœ€è¦/dev/ttyUSB0çš„æƒé™ã€‚</p>
  <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo chmod </span>777 /dev/ttyUSB0
</code></pre></div>  </div>
</blockquote>

<h3 id="æµ‹è¯•">æµ‹è¯•</h3>
<ul>
  <li>å¯åŠ¨rosæœåŠ¡</li>
  <li>å¯åŠ¨rosserialæœåŠ¡</li>
  <li>æŸ¥çœ‹msgæ•°æ®</li>
  <li>å‘é€æ•°æ®</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>roscore

rosrun rosserial_python serial_node.py _port:<span class="o">=</span>/dev/ttyUSB0

rostopic <span class="nb">echo</span> /led_out

rostopic pub <span class="nt">-1</span> /led_out std_msgs/Byte 1
</code></pre></div></div>

<p>å‘é€æ•°å­—1æ‰“å¼€å°ç¯ï¼ˆé1å³å¯ï¼‰ï¼Œå‘é€æ•°å­—0å…³é—­ã€‚</p>

<blockquote>
  <p><code class="highlighter-rouge">rosserial_python</code>å¯é€šè¿‡_portæŒ‡å®šè®¾å¤‡ï¼Œé€šè¿‡_baudæŒ‡å®šæ³¢ç‰¹ç‡ï¼ˆä¹¦ä¸­æ˜¯115200å¹¶ä¸èƒ½æˆåŠŸè¿æ¥ï¼Œæ”¹ä¸º57600åæˆåŠŸï¼Œåæ”¹ä¸ºä¸è®¾ç½®å¯ä»¥è‡ªåŠ¨è®¾ç½®ï¼‰ã€‚
rostopic pub <topic-name> <topic-type> [data...]
`rostopic pub`ä¸­-1æ˜¯æ‰§è¡Œä¸€æ¬¡ã€‚</topic-type></topic-name></p>
</blockquote>

<p><a href="http://wiki.ros.org/rosserial/">rosserial</a>
<a href="http://wiki.ros.org/rostopic">rostopic</a></p>

<h2 id="publisher">publisher</h2>
<p>ç”¨å¼•çº¿å°†VCC/GNDè¾“å…¥pin9ï¼Œå°†pin8è¾“å‡ºç”µå¹³å€¼ã€‚</p>

<p>arduinoå‘é€pin9å¼•è„šçš„å€¼åˆ°/led_outã€‚</p>

<h3 id="ç¡¬ä»¶-1">ç¡¬ä»¶</h3>
<p><img src="/imgs/ç”µå­/arduino/arduino-rosserial/2.png" alt="ros_pub" /></p>

<h3 id="ä»£ç -1">ä»£ç </h3>
<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;ros.h&gt;
#include &lt;std_msgs/Byte.h&gt;
</span>
<span class="n">ros</span><span class="o">::</span><span class="n">NodeHandle</span> <span class="n">nh</span><span class="p">;</span>
<span class="n">std_msgs</span><span class="o">::</span><span class="n">Byte</span> <span class="n">led_msg</span><span class="p">;</span>
<span class="n">ros</span><span class="o">::</span><span class="n">Publisher</span> <span class="nf">pub</span><span class="p">(</span><span class="s">"led_out"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">led_msg</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// put your setup code here, to run once:</span>
  <span class="n">nh</span><span class="p">.</span><span class="n">initNode</span><span class="p">();</span>
  <span class="n">nh</span><span class="p">.</span><span class="n">advertise</span><span class="p">(</span><span class="n">pub</span><span class="p">);</span>

  <span class="n">pinMode</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>
  <span class="n">pinMode</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="n">INPUT</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">loop</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// put your main code here, to run repeatedly:</span>
  <span class="kt">uint8_t</span> <span class="n">reading</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">static</span> <span class="kt">uint32_t</span> <span class="n">pre_time</span><span class="p">;</span>

  <span class="n">reading</span> <span class="o">=</span> <span class="n">digitalRead</span><span class="p">(</span><span class="mi">9</span><span class="p">);</span>
  <span class="n">digitalWrite</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">reading</span><span class="p">);</span>
  
  <span class="k">if</span><span class="p">(</span><span class="n">millis</span><span class="p">()</span> <span class="o">-</span> <span class="n">pre_time</span> <span class="o">&gt;=</span> <span class="mi">50</span><span class="p">){</span>
    <span class="n">led_msg</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">reading</span><span class="p">;</span>
    <span class="n">pub</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led_msg</span><span class="p">);</span>
    <span class="n">pre_time</span> <span class="o">=</span> <span class="n">millis</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="n">nh</span><span class="p">.</span><span class="n">spinOnce</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="æµ‹è¯•-1">æµ‹è¯•</h3>
<ul>
  <li>å¯åŠ¨rosæœåŠ¡</li>
  <li>å¯åŠ¨rosserialæœåŠ¡</li>
  <li>æŸ¥çœ‹msgæ•°æ®</li>
  <li>è¾“å…¥ç”µå¹³åˆ°è¾“å…¥å¼•è„š</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>roscore

rosrun rosserial_python serial_node.py _port:<span class="o">=</span>/dev/ttyUSB0

rostopic <span class="nb">echo</span> /led_out
</code></pre></div></div>

<p>å°†å¼•è„šVCC/GNDå¼•åˆ°pin9ã€‚</p>

<p>åœ¨pcï¼Œ<code class="highlighter-rouge">rostopic echo</code>å‘½ä»¤çš„ç»ˆç«¯å¯ä»¥çœ‹åˆ°æ¥è‡ªæ¿å­çš„/led_outæ•°æ®ã€‚</p>
:ET