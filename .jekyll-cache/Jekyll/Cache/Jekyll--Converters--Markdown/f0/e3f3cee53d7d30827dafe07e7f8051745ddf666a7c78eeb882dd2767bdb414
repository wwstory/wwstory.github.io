I"²‚<h1 id="multipart">multipart</h1>

<h2 id="é¡¹ç›®ç»“æ„">é¡¹ç›®ç»“æ„</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.
â”œâ”€â”€ build.gradle
â””â”€â”€ src
    â””â”€â”€ main
        â”œâ”€â”€ java
        â”‚Â Â  â””â”€â”€ com
        â”‚Â Â      â””â”€â”€ yww
        â”‚Â Â          â””â”€â”€ UploadsController.java
        â”œâ”€â”€ resources
        â”‚Â Â  â””â”€â”€ application.properties
        â””â”€â”€ webapp
            â”œâ”€â”€ index.jsp
            â””â”€â”€ WEB-INF
                â”œâ”€â”€ applicationContext.xml
                â”œâ”€â”€ dispatcher-servlet.xml
                â”œâ”€â”€ jsp
                â”‚Â Â  â””â”€â”€ uploads.jsp
                â””â”€â”€ web.xml
</code></pre></div></div>

<p>æœ€ç®€çš„è®¾ç½®åªéœ€è¦<code class="highlighter-rouge">web.xml</code>ä¸­é…ç½®ï¼Œå’Œ<code class="highlighter-rouge">UploadsController.java</code>ä½¿ç”¨<code class="highlighter-rouge">@RequestPart</code>å³å¯ã€‚</p>

<h2 id="multipartè§£æå™¨">multipartè§£æå™¨</h2>

<p><code class="highlighter-rouge">DispatcherServlet</code>å¹¶æ²¡æœ‰å®ç°ä»»ä½•è§£æmultipartè¯·æ±‚æ•°æ®çš„åŠŸèƒ½ã€‚å®ƒå°†è¯¥ä»»åŠ¡å§”æ‰˜ç»™äº†Springä¸­<code class="highlighter-rouge">MultipartResolver</code>æ¥å£å®ç°ï¼Œé€šè¿‡è¯¥å®ç°ç±»è§£æmultipartè¯·æ±‚ä¸­çš„å†…å®¹ã€‚</p>

<p>PS: <code class="highlighter-rouge">Part</code>æ–¹å¼ä¸éœ€è¦é…ç½®<code class="highlighter-rouge">MultipartResolver</code>ã€‚</p>

<p>Springå†…ç½®2ä¸ª<code class="highlighter-rouge">MultipartResolver</code>å®ç°ï¼š</p>
<ul>
  <li><del><code class="highlighter-rouge">CommonsMultipartResolver</code>ï¼šä½¿ç”¨Jakarta Commons FileUploadè§£æmultipartè¯·æ±‚ã€‚ï¼ˆä¸å»ºè®®ä½¿ç”¨ï¼‰</del></li>
  <li><code class="highlighter-rouge">StandardServletMultipartResolver</code>ï¼šä¾èµ–äºServlet 3.0å¯¹multipartè¯·æ±‚çš„æ”¯æŒã€‚ï¼ˆéœ€Spring 3.1ä»¥ä¸Šç‰ˆæœ¬ï¼‰</li>
</ul>

<h2 id="é…ç½®multipartè§£æå™¨">é…ç½®multipartè§£æå™¨</h2>

<p>æœ€ç®€å•çš„é…ç½®ï¼Œåªéœ€å£°æ˜ä¸ºBeanå³å¯ã€‚ï¼ˆä½¿ç”¨<code class="highlighter-rouge">Part</code>å¯çœï¼‰</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">MultipartResolver</span> <span class="nf">multipartResolver</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">StandardServletMultipartResolver</span><span class="o">();</span>
    <span class="o">}</span>
</code></pre></div></div>

<p>æ›´å¤šçš„è®¾ç½®ã€‚æˆ‘ä»¬éœ€è¦åœ¨<code class="highlighter-rouge">Servlet</code>ä¸­é…ç½®ï¼Œä½¿ç”¨<code class="highlighter-rouge">web.xml</code>é…ç½®æ¯”è¾ƒç›´è§‚ç®€ä¾¿ã€‚æŒ‡å®šäº†ä¸Šä¼ ä½ç½®ï¼Œæ–‡ä»¶å¤§å°ï¼Œè¯·æ±‚å¤§å°ã€‚</p>

<p>[<code class="highlighter-rouge">web.xml</code>]</p>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;web-app</span> <span class="na">xmlns=</span><span class="s">"http://xmlns.jcp.org/xml/ns/javaee"</span>
         <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
         <span class="na">xsi:schemaLocation=</span><span class="s">"http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd"</span>
         <span class="na">version=</span><span class="s">"4.0"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;context-param&gt;</span>
        <span class="nt">&lt;param-name&gt;</span>contextConfigLocation<span class="nt">&lt;/param-name&gt;</span>
        <span class="nt">&lt;param-value&gt;</span>/WEB-INF/applicationContext.xml<span class="nt">&lt;/param-value&gt;</span>
    <span class="nt">&lt;/context-param&gt;</span>
    <span class="nt">&lt;listener&gt;</span>
        <span class="nt">&lt;listener-class&gt;</span>org.springframework.web.context.ContextLoaderListener<span class="nt">&lt;/listener-class&gt;</span>
    <span class="nt">&lt;/listener&gt;</span>
    <span class="nt">&lt;servlet&gt;</span>
        <span class="nt">&lt;servlet-name&gt;</span>dispatcher<span class="nt">&lt;/servlet-name&gt;</span>
        <span class="nt">&lt;servlet-class&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="nt">&lt;/servlet-class&gt;</span>
        <span class="nt">&lt;load-on-startup&gt;</span>1<span class="nt">&lt;/load-on-startup&gt;</span>
        <span class="nt">&lt;multipart-config&gt;</span>
            <span class="nt">&lt;location&gt;</span>/tmp/uploads<span class="nt">&lt;/location&gt;</span>
            <span class="nt">&lt;max-file-size&gt;</span>2048000<span class="nt">&lt;/max-file-size&gt;</span>
            <span class="nt">&lt;max-request-size&gt;</span>4096000<span class="nt">&lt;/max-request-size&gt;</span>
        <span class="nt">&lt;/multipart-config&gt;</span>
    <span class="nt">&lt;/servlet&gt;</span>
    <span class="nt">&lt;servlet-mapping&gt;</span>
        <span class="nt">&lt;servlet-name&gt;</span>dispatcher<span class="nt">&lt;/servlet-name&gt;</span>
        <span class="c">&lt;!--        &lt;url-pattern&gt;*.form&lt;/url-pattern&gt;--&gt;</span>
        <span class="nt">&lt;url-pattern&gt;</span>/<span class="nt">&lt;/url-pattern&gt;</span>
    <span class="nt">&lt;/servlet-mapping&gt;</span>
<span class="nt">&lt;/web-app&gt;</span>
</code></pre></div></div>

<blockquote>
  <p>ä½¿ç”¨javaé…ç½®ï¼Œåœ¨å®ç°<code class="highlighter-rouge">WebApplicationInitializer</code>ç±»çš„<code class="highlighter-rouge">onStartup()</code>æ–¹æ³•ä¸­ï¼Œæˆ–ç»§æ‰¿<code class="highlighter-rouge">AbstractAnnotationConfigDispatcherServletInitializer</code>ç±»çš„<code class="highlighter-rouge">customizeRegistration</code>æ–¹æ³•ä¸­è®¾ç½®<code class="highlighter-rouge">registration.setMultipartConfig()</code>é…ç½®ã€‚</p>
</blockquote>

<h2 id="å¤„ç†multipartè¯·æ±‚">å¤„ç†multipartè¯·æ±‚</h2>

<h3 id="è¡¨å•">è¡¨å•</h3>

<p>è®¾ç½®<code class="highlighter-rouge">enctype</code>ä¸º`multipart/form-dataâ€™ï¼Œè¿™ä¼šå‘Šè¯‰æµè§ˆå™¨ä»¥multipartæ•°æ®çš„å½¢å¼æäº¤è¡¨å•ã€‚</p>

<p>[<code class="highlighter-rouge">WEB-INF/jsp/uploads.jsp</code>]</p>
<div class="language-jsp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"UTF-8"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;title&gt;</span>Title<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>uploads<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">"post"</span> <span class="na">enctype=</span><span class="s">"multipart/form-data"</span> <span class="nt">&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"file"</span> <span class="na">name=</span><span class="s">"img"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<h3 id="æ§åˆ¶å™¨">æ§åˆ¶å™¨</h3>

<p><code class="highlighter-rouge">@RequestPart</code>æŒ‡å®šè¯·æ±‚ä¸­å¯¹åº”partæ•°æ®ã€‚å¦‚æœæäº¤è¡¨å•æ—¶æ²¡æœ‰é€‰æ‹©æ–‡ä»¶ï¼Œé‚£ä¹ˆè¿™ä¸ªæ•°ç»„ä¼šæ˜¯ç©ºï¼Œè€Œä¸æ˜¯nullã€‚</p>

<p>[<code class="highlighter-rouge">UploadsController.java</code>]</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">com.yww</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.Errors</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMethod</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestPart</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.servlet.http.Part</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>

<span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UploadsController</span> <span class="o">{</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/uploads"</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="nc">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">uploads</span><span class="o">(){</span>
        <span class="k">return</span> <span class="s">"uploads"</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/uploads"</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="nc">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">)</span>
<span class="c1">//    public String processImage(@RequestPart("img") byte[] img) {</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">processImage</span><span class="o">(</span><span class="nd">@RequestPart</span><span class="o">(</span><span class="s">"img"</span><span class="o">)</span> <span class="nc">Part</span> <span class="n">img</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">img</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"/tmp/"</span> <span class="o">+</span> <span class="n">img</span><span class="o">.</span><span class="na">getSubmittedFileName</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="s">"uploads"</span><span class="o">;</span>
    <span class="o">}</span>
    
<span class="o">}</span>
</code></pre></div></div>

<blockquote>
  <p><code class="highlighter-rouge">web.xml</code>å’Œ<code class="highlighter-rouge">UploadsController.java</code>ä¸­éƒ½è®¾ç½®äº†å†™å…¥çš„è·¯å¾„ï¼Œä½†æœ€åæ˜¯ä»¥æ§åˆ¶å™¨ä¸­çš„ä¸ºå‡†ã€‚</p>
</blockquote>

<p>ä½¿ç”¨ä¸Šä¼ æ–‡ä»¶çš„åŸå§‹<code class="highlighter-rouge">byte[]</code>æ¯”è¾ƒç®€å•ä½†åŠŸèƒ½æœ‰é™ã€‚å› æ­¤ï¼ŒSpringè¿˜æä¾›äº†2ç§æ¥å£å¤„ç†ï¼š<code class="highlighter-rouge">Part</code>,<code class="highlighter-rouge">MultipartFile</code>ï¼ŒäºŒè€…æ–¹æ³•ååˆ†ç›¸ä¼¼ã€‚</p>

<h2 id="htmlé¡µé¢">htmlé¡µé¢</h2>

<p>[<code class="highlighter-rouge">uploads.jsp</code>]</p>
<div class="language-jsp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"UTF-8"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;title&gt;</span>Title<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>uploads<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">"post"</span> <span class="na">enctype=</span><span class="s">"multipart/form-data"</span> <span class="nt">&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"file"</span> <span class="na">name=</span><span class="s">"img"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<h1 id="å¼‚å¸¸">å¼‚å¸¸</h1>

<p>ä¸ç®¡æ˜¯å¦æ­£å¸¸è¿è¡Œï¼ŒServletè¯·æ±‚çš„è¾“å‡ºéƒ½æ˜¯ä¸€ä¸ªServletå“åº”ã€‚å¦‚æœåœ¨è¯·æ±‚å¤„ç†çš„æ—¶å€™å‡ºç°äº†å¼‚å¸¸ï¼Œé‚£å®ƒçš„è¾“å‡ºä¾ç„¶ä¼šæ˜¯Servletå“åº”ã€‚å¼‚å¸¸å¿…é¡»è¦ä»¥æŸç§æ–¹å¼è½¬æ¢ä¸ºå“åº”ã€‚</p>

<p>Springæä¾›äº†å¤šç§æ–¹å¼å°†å¼‚å¸¸è½¬æ¢ä¸ºå“åº”ï¼š</p>
<ul>
  <li>ç‰¹å®šçš„Springå¼‚å¸¸ä¼šè‡ªåŠ¨æ˜ å°„ä¸ºæŒ‡å®šçš„HTTPçŠ¶æ€ç ã€‚</li>
  <li>å¼‚å¸¸ä¸Šå¯ä»¥æ·»åŠ @ResponseStatusæ³¨è§£ï¼Œä»è€Œå°†å…¶æ˜ å°„ä¸ºæŸä¸€ä¸ªHTTPçŠ¶æ€ç ã€‚</li>
  <li>åœ¨æ–¹æ³•ä¸Šå¯ä»¥æ·»åŠ @ExceptionHandleæ³¨è§£ï¼Œä½¿å…¶ç”¨æ¥å¤„ç†å¼‚å¸¸ã€‚</li>
</ul>

<h2 id="é¡¹ç›®ç»“æ„-1">é¡¹ç›®ç»“æ„</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.
â”œâ”€â”€ build.gradle
â””â”€â”€ src
    â””â”€â”€ main
        â”œâ”€â”€ java
        â”‚Â Â  â””â”€â”€ com
        â”‚Â Â      â””â”€â”€ yww
        â”‚Â Â          â”œâ”€â”€ UserController.java
        â”‚Â Â          â”œâ”€â”€ User.java
        â”‚Â Â          â”œâ”€â”€ UserNotFoundException.java
        â”‚Â Â          â””â”€â”€ UserNotFoundHandler.java
        â”œâ”€â”€ resources
        â”‚Â Â  â””â”€â”€ application.properties
        â””â”€â”€ webapp
            â”œâ”€â”€ index.jsp
            â””â”€â”€ WEB-INF
                â”œâ”€â”€ applicationContext.xml
                â”œâ”€â”€ dispatcher-servlet.xml
                â”œâ”€â”€ jsp
                â”‚Â Â  â””â”€â”€ error
                â”‚Â Â   Â Â  â””â”€â”€ usernotfound.jsp
                â””â”€â”€ web.xml
</code></pre></div></div>

<h2 id="å¼‚å¸¸æ˜ å°„httpçŠ¶æ€ç ">å¼‚å¸¸æ˜ å°„HTTPçŠ¶æ€ç </h2>

<table>
  <thead>
    <tr>
      <th>Springå¼‚å¸¸</th>
      <th>HTTPçŠ¶æ€ç </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>BindException</td>
      <td>400 - Bad Request</td>
    </tr>
    <tr>
      <td>ConversionNotSupportedException</td>
      <td>500 - Internal Server Error</td>
    </tr>
    <tr>
      <td>HttpMediaTypeNotAcceptableException</td>
      <td>406 - Not Acceptable</td>
    </tr>
    <tr>
      <td>HttpMediaTypeNotSupportedException</td>
      <td>415 - Unsupported Media Type</td>
    </tr>
    <tr>
      <td>HttpMessageNotReadableException</td>
      <td>400 - Bad Request</td>
    </tr>
    <tr>
      <td>HttpMessageNotWritableException</td>
      <td>500 - Internal Server Error</td>
    </tr>
    <tr>
      <td>HttpRequestMethodNotSupportedException</td>
      <td>405 - Method Not Allowed</td>
    </tr>
    <tr>
      <td>MethodArgumentNotValidException</td>
      <td>400 - Bad Request</td>
    </tr>
    <tr>
      <td>MissingServletRequestParameterException</td>
      <td>400 - Bad Request</td>
    </tr>
    <tr>
      <td>MissingServletRequestPartException</td>
      <td>400 - Bad Request</td>
    </tr>
    <tr>
      <td>TypeMismatchException</td>
      <td>400 - Bad Request</td>
    </tr>
  </tbody>
</table>

<p>ä»¥ä¸Šå¼‚å¸¸ï¼Œä¸€èˆ¬ä¼šç”±Springè‡ªèº«æŠ›å‡ºã€‚</p>

<p>å¦‚æœéœ€è¦è‡ªå®šä¹‰å¼‚å¸¸ï¼Œå¹¶å°†å…¶æ˜ å°„åˆ°HTTPçŠ¶æ€ç ä¸Šï¼Œåªéœ€è¦ä½¿ç”¨<code class="highlighter-rouge">@ResponseStatus</code>æ³¨è§£è‡ªå®šä¹‰çš„å¼‚å¸¸ç±»å³å¯ã€‚ä½¿ç”¨æ—¶ï¼Œåœ¨éœ€è¦çš„åœ°æ–¹æŠ›å‡ºå³å¯ã€‚</p>

<p>[<code class="highlighter-rouge">UserNotFoundException.java</code>]</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">com.yww</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.http.HttpStatus</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ResponseStatus</span><span class="o">;</span>

<span class="nd">@ResponseStatus</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="nc">HttpStatus</span><span class="o">.</span><span class="na">NOT_FOUND</span><span class="o">,</span> <span class="n">reason</span><span class="o">=</span><span class="s">"User Not Found"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserNotFoundException</span> <span class="kd">extends</span> <span class="nc">RuntimeException</span> <span class="o">{</span>

<span class="o">}</span>
</code></pre></div></div>

<p>åœ¨å¼•å…¥<code class="highlighter-rouge">@ResponseStatus</code>æ³¨è§£ä¹‹åï¼Œå¦‚æœæ§åˆ¶å™¨æ–¹æ³•æŠ›å‡ºè¿™ä¸ªå¼‚å¸¸çš„è¯ï¼Œå“åº”å°†ä¼šå…·æœ‰<code class="highlighter-rouge">404çŠ¶æ€ç </code>ã€‚</p>

<h2 id="å¼‚å¸¸å¤„ç†">å¼‚å¸¸å¤„ç†</h2>

<p>ä¸ºäº†å¤„ç†å¼‚å¸¸æƒ…å†µï¼Œå¯ä»¥åœ¨æ§åˆ¶å™¨é‡Œæ·»åŠ ä¸€ä¸ªå¸¦<code class="highlighter-rouge">@ExceptionHandler</code>æ³¨è§£çš„æ–¹æ³•ï¼Œå½“æŒ‡å®šå¼‚å¸¸æŠ›å‡ºæ—¶ï¼Œå®ƒä¼šå¤„ç†ã€‚</p>

<p>[<code class="highlighter-rouge">UserController.java</code>]</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">com.yww</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.ui.ModelMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ExceptionHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMethod</span><span class="o">;</span>

<span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/user"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserController</span> <span class="o">{</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">method</span> <span class="o">=</span> <span class="nc">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">printHome</span><span class="o">(</span><span class="nc">ModelMap</span> <span class="n">model</span><span class="o">){</span>
<span class="c1">//        String username = "yww";</span>
        <span class="nc">String</span> <span class="n">username</span> <span class="o">=</span> <span class="s">"yww_no"</span><span class="o">;</span>
        <span class="k">if</span><span class="o">(</span><span class="n">username</span> <span class="o">==</span> <span class="s">"yww"</span><span class="o">){</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
        <span class="o">}</span><span class="k">else</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">UserNotFoundException</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="s">"home"</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@ExceptionHandler</span><span class="o">(</span><span class="nc">UserNotFoundException</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">handleUserNotFound</span><span class="o">(){</span>
        <span class="k">return</span> <span class="s">"error/usernotfound"</span><span class="o">;</span>    <span class="c1">// è§†å›¾</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>PS:è¿™æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœæ¯ä¸ªæ§åˆ¶å™¨éƒ½éœ€è¦ä½¿ç”¨è¿™ä¸ªå¼‚å¸¸å¤„ç†ï¼Œåˆ™éœ€è¦æ¯ä¸ªæ§åˆ¶å™¨éƒ½å†™ä¸Šè¿™ä¸ª<code class="highlighter-rouge">@ExceptionHandler</code>çš„æ–¹æ³•ï¼Œæˆ–è€…ç»§æ‰¿ä¸€ä¸ªçˆ¶ç±»ã€‚Springæä¾›äº†ä¸€ä¸ªæ›´å¥½çš„è§£å†³æ–¹å¼ï¼Œ<code class="highlighter-rouge">æ§åˆ¶å™¨é€šçŸ¥</code>ç”¨äºå¤„ç†æ‰€æœ‰æ§åˆ¶å™¨ä¸­çš„<code class="highlighter-rouge">å¼‚å¸¸</code>,<code class="highlighter-rouge">åˆå§‹åŒ–</code>,<code class="highlighter-rouge">æ¨¡å‹å±æ€§</code>ã€‚ï¼ˆå¦‚ä¸‹ï¼‰</p>

<h1 id="æ§åˆ¶å™¨é€šçŸ¥">æ§åˆ¶å™¨é€šçŸ¥</h1>

<p>æ§åˆ¶å™¨é€šçŸ¥ï¼ˆcontroller adviceï¼‰æ˜¯ä»»æ„å¸¦æœ‰<code class="highlighter-rouge">@ControllerAdvice</code>æ³¨è§£çš„ç±»ï¼Œè¿™ä¸ªç±»ä¼šåŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªå¦‚ä¸‹ç±»å‹çš„æ–¹æ³•ï¼š</p>
<ul>
  <li><code class="highlighter-rouge">@ExceptionHandler</code>æ ‡æ³¨çš„æ–¹æ³•ã€‚</li>
  <li><code class="highlighter-rouge">@InitBinder</code>æ ‡æ³¨çš„æ–¹æ³•ã€‚</li>
  <li><code class="highlighter-rouge">@ModelAttribute</code>æ ‡æ³¨çš„æ–¹æ³•ã€‚</li>
</ul>

<blockquote>
  <p>ç”±æ­¤å¯è§ï¼Œæ§åˆ¶å™¨é€šçŸ¥ä¸ä»…å¯ä»¥ä½œä¸ºå¼‚å¸¸çš„é›†ä¸­å¤„ç†ï¼Œè¿˜æœ‰å…¶å®ƒ2ç§åŠŸèƒ½ä½¿ç”¨ã€‚</p>
</blockquote>

<p>åœ¨å¸¦æœ‰<code class="highlighter-rouge">@ControllerAdvice</code>æ³¨è§£çš„ç±»ä¸­ï¼Œä»¥ä¸Šæ‰€è¿°çš„æ–¹æ³•ä¼šè¿ç”¨åˆ°æ•´ä¸ªåº”ç”¨ç¨‹åºæ‰€æœ‰æ§åˆ¶å™¨å¸¦æœ‰<code class="highlighter-rouge">@RequestMapping</code>æ³¨è§£çš„æ–¹æ³•ä¸Šã€‚</p>

<blockquote>
  <p><code class="highlighter-rouge">@ControllerAdvice</code>æœ¬èº«å·²ç»ä½¿ç”¨äº†<code class="highlighter-rouge">@Component</code>ã€‚</p>
</blockquote>

<p>[<code class="highlighter-rouge">UserNotFoundHandler.java</code>]</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">com.yww</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ControllerAdvice</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ExceptionHandler</span><span class="o">;</span>

<span class="nd">@ControllerAdvice</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserNotFoundHandler</span> <span class="o">{</span>

    <span class="nd">@ExceptionHandler</span><span class="o">(</span><span class="nc">UserNotFoundException</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">handleUserNotFound</span><span class="o">(){</span>
        <span class="k">return</span> <span class="s">"error/usernotfound"</span><span class="o">;</span>    <span class="c1">// è§†å›¾</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h1 id="è·¨é‡å®šå‘è¯·æ±‚ä¼ é€’æ•°æ®">è·¨é‡å®šå‘è¯·æ±‚ä¼ é€’æ•°æ®</h1>

<p>åœ¨å¤„ç†å®ŒPOSTè¯·æ±‚åï¼Œæœ€ä½³å®è·µæ˜¯æ‰§è¡Œä¸€ä¸‹é‡å®šå‘ã€‚ï¼ˆé¿å…ç”¨æˆ·ç‚¹å‡»åˆ·æ–°æˆ–è¿”å›ï¼Œå¯¼è‡´å®¢æˆ·ç«¯é‡æ–°æ‰§è¡Œå±é™©çš„POSTè¯·æ±‚ã€‚ï¼‰</p>

<p>ä¸€èˆ¬æ¥è¯´ï¼Œå½“ä¸€ä¸ªå¤„ç†å™¨æ–¹æ³•å®Œæˆåï¼Œè¯¥æ–¹æ³•æ‰€æŒ‡å®šçš„æ¨¡å‹æ•°æ®å°†ä¼šå¤åˆ¶åˆ°è¯·æ±‚ä¸­ï¼Œä½œä¸ºè¯·æ±‚ä¸­çš„å±æ€§ï¼Œè¯·æ±‚ä¼šè½¬å‘ï¼ˆforwardï¼‰åˆ°è§†å›¾ä¸Šè¿›è¡Œæ¸²æŸ“ã€‚å› ä¸ºæ§åˆ¶å™¨æ–¹æ³•å’Œè§†å›¾æ‰€å¤„ç†çš„æ˜¯åŒä¸€ä¸ªè¯·æ±‚ï¼Œæ‰€ä»¥åœ¨è½¬å‘è¿‡ç¨‹ä¸­å±æ€§èƒ½å¤Ÿå¾—ä»¥ä¿å­˜ã€‚</p>

<p>ä½†æ˜¯ï¼Œå½“æ§åˆ¶å™¨çš„ç»“æœæ˜¯é‡å®šå‘çš„è¯ï¼ŒåŸå§‹çš„è¯·æ±‚å°±ç»“æŸäº†ï¼Œå¹¶ä¸”ä¼šå‘èµ·ä¸€ä¸ªæ–°çš„GETè¯·æ±‚ã€‚åŸå§‹è¯·æ±‚ä¸­æ‰€å¸¦çš„æ¨¡å‹æ•°æ®ä¹Ÿå°±æ¶ˆäº¡äº†ã€‚</p>

<p>äºæ˜¯ï¼Œå¯¹äºé‡å®šå‘æ¥è¯´ï¼Œæ¨¡å‹ä¸èƒ½ç”¨æ¥ä¼ é€’æ•°æ®ã€‚å¯ä»¥ä½¿ç”¨å…¶å®ƒæ–¹æ¡ˆï¼š</p>
<ul>
  <li>ä½¿ç”¨URLæ¨¡æ¿ä»¥è·¯å¾„å˜é‡æˆ–æŸ¥è¯¢å‚æ•°çš„å½¢å¼ä¼ é€’æ•°æ®ã€‚</li>
  <li>é€šè¿‡flashå±æ€§å‘é€æ•°æ®ã€‚</li>
</ul>

<h2 id="urlä¼ é€’æ•°æ®">urlä¼ é€’æ•°æ®</h2>

<p>æœ€ç®€å•çš„å°±æ˜¯ç”¨è¿‡æ‹¼æ¥å­—ç¬¦ä¸²ã€‚ä½†å½“æ„å»ºURLæˆ–SQLæŸ¥è¯¢æ—¶ï¼Œä½¿ç”¨å­—ç¬¦ä¸²è¿æ¥å¾ˆå±é™©ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">return</span> <span class="s">"redirect:/user/"</span> <span class="o">+</span> <span class="s">"username"</span><span class="o">;</span>
</code></pre></div></div>

<p>ä½¿ç”¨å ä½ç¬¦è§£å†³ï¼Œ<code class="highlighter-rouge">{username}</code>ä½œä¸ºå ä½ç¬¦å¡«å……åˆ°URLæ¨¡æ¿ä¸­ï¼Œè€Œæ¨¡å‹ä¸­çš„<code class="highlighter-rouge">id</code>å±æ€§æ²¡æœ‰åŒ¹é…åˆ°URLä¸­çš„å ä½ç¬¦ï¼Œæ‰€ä»¥å®ƒä¼šè‡ªåŠ¨ä»¥æŸ¥è¯¢å‚æ•°çš„å½¢å¼é™„åŠ åˆ°é‡å®šå‘URLä¸Šã€‚</p>

<p>[<code class="highlighter-rouge">UserRedirectUrlController.java</code>]</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">com.yww</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.ui.Model</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="o">;</span>

<span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserRedirectUrlController</span> <span class="o">{</span>
    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/user_re_url"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getUser</span><span class="o">(</span><span class="nc">Model</span> <span class="n">model</span><span class="o">){</span>
        <span class="nc">String</span> <span class="n">username</span> <span class="o">=</span> <span class="s">"yww"</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">1001</span><span class="o">;</span>
        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"username"</span><span class="o">,</span> <span class="n">username</span><span class="o">);</span>
        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"id"</span><span class="o">,</span> <span class="n">id</span><span class="o">);</span>

        <span class="k">return</span> <span class="s">"redirect:/user/{username}"</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="flashå±æ€§ä¼ é€’æ•°æ®">flashå±æ€§ä¼ é€’æ•°æ®</h2>

<p>ä½¿ç”¨è·¯å¾„é‡å®šå‘ä¼ é€’æ•°æ®ï¼Œåªèƒ½å‘é€å­—ç¬¦ä¸²å’Œæ•°å­—è¿™æ ·ç®€å•çš„æ•°æ®ï¼Œå¦‚æœéœ€è¦å‘é€å¦‚å¯¹è±¡çš„æ•°æ®ï¼Œéœ€è¦ä½¿ç”¨<code class="highlighter-rouge">flash</code>ã€‚</p>

<p>è¿™å°†ä¼šæŠŠæ•°æ®æ”¾åˆ°ä¼šè¯ä¸­ï¼Œå†é‡å®šå‘åå–å‡ºï¼Œæˆ‘ä»¬å†è´Ÿè´£æ¸…é™¤æ‰ã€‚Springæä¾›äº†é€šè¿‡<code class="highlighter-rouge">RedirectAttributes</code>è®¾ç½®<code class="highlighter-rouge">flash</code>å±æ€§çš„æ–¹æ³•ã€‚å®ƒæ˜¯<code class="highlighter-rouge">Model</code>çš„å­æ¥å£ã€‚</p>

<p>[<code class="highlighter-rouge">UserRedirectFlashController.java</code>]</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">com.yww</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.servlet.mvc.support.RedirectAttributes</span><span class="o">;</span>

<span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserRedirectFlashController</span> <span class="o">{</span>
    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/user_re_flash"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">postUser</span><span class="o">(</span><span class="nc">RedirectAttributes</span> <span class="n">model</span><span class="o">){</span>
        <span class="nc">String</span> <span class="n">username</span> <span class="o">=</span> <span class="s">"yww"</span><span class="o">;</span>
        <span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">User</span><span class="o">();</span>
        <span class="n">user</span><span class="o">.</span><span class="na">username</span> <span class="o">=</span> <span class="s">"yww"</span><span class="o">;</span>
        <span class="n">user</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="mi">1001</span><span class="o">;</span>

        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"username"</span><span class="o">,</span> <span class="n">username</span><span class="o">);</span>
        <span class="n">model</span><span class="o">.</span><span class="na">addFlashAttribute</span><span class="o">(</span><span class="s">"user"</span><span class="o">,</span> <span class="n">user</span><span class="o">);</span>

        <span class="k">return</span> <span class="s">"redirect:/user/{username}"</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>ä¸‹ä¸€ä¸ªè¯·æ±‚çš„æ§åˆ¶å™¨å¦‚ä½•å–å¾—flashçš„æ•°æ®ã€‚</p>

<p>[<code class="highlighter-rouge">ShowUserController.java</code>]</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">com.yww</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.servlet.mvc.support.RedirectAttributes</span><span class="o">;</span>

<span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserRedirectFlashController</span> <span class="o">{</span>
    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/user_re_flash"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">postUser</span><span class="o">(</span><span class="nc">RedirectAttributes</span> <span class="n">model</span><span class="o">){</span>
        <span class="nc">String</span> <span class="n">username</span> <span class="o">=</span> <span class="s">"yww"</span><span class="o">;</span>
        <span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">User</span><span class="o">();</span>
        <span class="n">user</span><span class="o">.</span><span class="na">username</span> <span class="o">=</span> <span class="s">"yww"</span><span class="o">;</span>
        <span class="n">user</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="mi">1001</span><span class="o">;</span>

        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"username"</span><span class="o">,</span> <span class="n">username</span><span class="o">);</span>
        <span class="n">model</span><span class="o">.</span><span class="na">addFlashAttribute</span><span class="o">(</span><span class="s">"user"</span><span class="o">,</span> <span class="n">user</span><span class="o">);</span>

        <span class="k">return</span> <span class="s">"redirect:/user/{username}"</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
:ET