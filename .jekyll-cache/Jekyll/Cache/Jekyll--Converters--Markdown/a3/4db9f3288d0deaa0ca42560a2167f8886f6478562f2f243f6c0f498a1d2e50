I"(Ü<h1 id="åŸºæœ¬ä½¿ç”¨">åŸºæœ¬ä½¿ç”¨</h1>
<p>pythonçº¿ç¨‹ä½¿ç”¨çš„ä¸¤ä¸ªæ¨¡å—ä¸ºï¼š <del><code class="highlighter-rouge">_thread</code>  <em>(ä¸æ¨èå†ä½¿ç”¨)</em></del>ã€ <code class="highlighter-rouge">threading</code>
 <em>ï¼ˆæŸ¥çœ‹threadingçš„æºç å¯ä»¥å‘ç°ï¼Œthreadingå®é™…æ˜¯å¯¹_threadè¿›ä¸€æ­¥çš„å°è£…ï¼Œå®˜æ–¹å°†å…¶ç§°ä¸º *Low-level threading API</em>ï¼Œä¸‹é¢ç®€å•å°è¯•ä½¿ç”¨_threadï¼‰*</p>

<p><del>è°ƒç”¨start_new_thread()å‡½æ•°ç”Ÿæˆæ–°çº¿ç¨‹
<strong>å‡½æ•°å£°æ˜</strong>ï¼š_thread.start_new_thread(function, args[, kwargs])
function: å­çº¿ç¨‹æ‰€æ‰§è¡Œçš„å‡½æ•°
args: ä¼ é€’çš„å‚æ•°ï¼Œå‚æ•°ç±»å‹å¿…é¡»æ˜¯<strong>å…ƒç»„</strong>
kwargs:å¯é€‰å‚æ•°</del></p>

<p><strong>ç¤ºä¾‹ï¼š</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!usr/bin/env python
#coding=utf-8
</span>
<span class="kn">import</span> <span class="nn">_thread</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">t_name</span><span class="p">):</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">t_name</span><span class="p">,</span> <span class="s">'end'</span><span class="p">)</span>

<span class="n">_thread</span><span class="o">.</span><span class="n">start_new_thread</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="p">(</span><span class="s">'my_thread_1'</span><span class="p">,))</span>    <span class="c1"># ä¼ é€’çš„å‚æ•°å¿…é¡»æ˜¯å…ƒç»„ç±»å‹
</span><span class="k">print</span><span class="p">(</span><span class="s">'main thread end'</span><span class="p">)</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>   <span class="c1"># æš‚åœä¸€ä¸‹ç­‰å¾…å­çº¿ç¨‹ï¼Œé¿å…ä¸»çº¿ç¨‹ç»“æŸåç›´æ¥é€€å‡ºï¼Œçœ‹ä¸åˆ°å­çº¿ç¨‹çš„è¾“å‡º
</span></code></pre></div></div>

<blockquote>
  <p><del>è¾“å‡º</del></p>
  <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>main thread end
my_thread_1 end
</code></pre></div>  </div>
</blockquote>

<p><strong>æ›´å¤š</strong>ï¼š<a href="https://docs.python.org/3/library/_thread.html">_thread â€” Low-level threading API</a></p>

<h2 id="threadingæ¨¡å—">threadingæ¨¡å—</h2>
<p><strong>éœ€è¦ import threading</strong>
threadingæ¨¡å—æä¾›äº†æ¯”_threadæ¨¡å—æ›´åŠ é«˜çº§åˆ«çš„æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š</p>
<blockquote>
  <ul>
    <li>threading.<strong>active_count</strong>(): è¿”å›å½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°é‡</li>
    <li>threading.<strong>current_thread</strong>(): è¿”å›å½“å‰è¿è¡Œçš„çº¿ç¨‹å¯¹è±¡</li>
    <li>threading.<strong>get_ident</strong>(): è¿”å›å½“å‰è¿è¡Œçš„çº¿ç¨‹æ ‡è¯†ç </li>
    <li>threading.<strong>enumerate</strong>(): è·å–è¿ä½œç€çš„çº¿ç¨‹å¯¹è±¡çš„åˆ—è¡¨ï¼ˆåŒ…å«è®¾ç½®äº†daemonå±æ€§çš„åå°çº¿ç¨‹ï¼‰</li>
    <li>threading.<strong>main_thread</strong>(): è·å–ä¸»çº¿ç¨‹å¯¹è±¡</li>
  </ul>
</blockquote>

<p>threadingæ¨¡å—åŒ…å«Threadç±»æ¥å¤„ç†çº¿ç¨‹
<strong>å‡½æ•°å£°æ˜</strong>ï¼šclass threading.<strong>Thread</strong>(group=None, target=None, name=None, args=(), kwargs={}, <em>, daemon=None)
*ï¼ˆgroup: å®˜æ–¹é¢„ç•™çš„å‚æ•°ï¼‰</em>
target: å­çº¿ç¨‹è¦æ‰§è¡Œçš„å‡½æ•°
name: ç»™å­çº¿ç¨‹å‘½å
args: ä¼ é€’å‚æ•°åˆ°è¦æ‰§è¡Œçš„å‡½æ•°ä¸­ <em>ï¼ˆç±»å‹ä¸ºå…ƒç»„ï¼‰</em>
daemon: å°†çº¿ç¨‹è®¾ç½®ä¸ºåå°çº¿ç¨‹ <sup>1</sup></p>

<blockquote>
  <p>Threadç±»åŒ…å«çš„æ–¹æ³•ï¼š</p>
  <ul>
    <li><strong>start</strong>(): å¼€å§‹çº¿ç¨‹ï¼Œå®ƒä¼šå®‰æ’åœ¨å•ç‹¬çš„æ§åˆ¶çº¿ç¨‹ä¸­ä½¿è¯¥å¯¹è±¡çš„<code class="highlighter-rouge">run()</code>æ–¹æ³•è¢«è°ƒç”¨ <em>(invoked)</em> <sup>2</sup> <em>ï¼ˆå¦‚æœå¤šæ¬¡è°ƒç”¨ï¼Œä¼šraise <code class="highlighter-rouge">RuntimeError</code>ï¼‰</em></li>
    <li><strong>run</strong>(): ä½ å¯ä»¥åœ¨å­ç±»ä¸­é‡å†™è¿™ä¸ªæ–¹æ³•ï¼Œæ ‡å‡†çš„<code class="highlighter-rouge">run()</code>æ–¹æ³•ä¼šåœ¨æ„é€ å™¨ä¼ é€’äº†<code class="highlighter-rouge">target</code>å‚æ•°åè°ƒç”¨å®ƒ</li>
    <li><strong>join</strong>(timeout=None): é˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´åˆ°ç­‰å¾…è°ƒç”¨äº†<code class="highlighter-rouge">join()</code>çš„çº¿ç¨‹ç»“æŸï¼Œæˆ–åˆ°è¾¾è®¾ç½®çš„è¶…æ—¶<code class="highlighter-rouge">timeout</code>çš„å‚æ•°ä¸ºæ­¢ <em>ï¼ˆå¦‚æœå°è¯•åŠ å…¥å½“å‰çº¿ç¨‹ <sup>3</sup>ï¼Œå› ä¸ºä¼šå‘ç”Ÿæ­»é”ï¼Œ<code class="highlighter-rouge">join()</code>ä¼šraise <code class="highlighter-rouge">RuntimeError</code>ã€‚åœ¨çº¿ç¨‹å¯åŠ¨å‰è°ƒç”¨<code class="highlighter-rouge">join()</code>ä¹Ÿä¼šæŠ¥ç›¸åŒçš„é”™è¯¯ï¼‰</em></li>
    <li><strong>name</strong>: çº¿ç¨‹å</li>
    <li><strong>ident</strong>: çº¿ç¨‹æ ‡è¯†ç  <em>ï¼ˆå¦‚æœçº¿ç¨‹æœª<code class="highlighter-rouge">start()</code>ï¼Œåˆ™ä¸º<code class="highlighter-rouge">None</code>ã€‚å®æµ‹çº¿ç¨‹ç»“æŸåï¼Œidentå€¼è¿˜å­˜åœ¨ï¼‰</em></li>
    <li><strong>is_alive</strong>(): åˆ¤æ–­çº¿ç¨‹æ˜¯å¦åœ¨è¿è¡Œ</li>
    <li><strong>daemon</strong>: æ˜¯å¦ä¸ºåå°çº¿ç¨‹çš„å±æ€§å€¼</li>
    <li><strong>isDaemon</strong>(): åˆ¤æ–­æ˜¯å¦ä¸ºåå°çº¿ç¨‹</li>
  </ul>
</blockquote>

<p><strong>æ›´å¤š</strong>ï¼š<a href="https://docs.python.org/3/library/threading.html">threading â€” Thread-based parallelism</a></p>

<h3 id="å‡½æ•°å½¢å¼">å‡½æ•°å½¢å¼</h3>
<p>ä½¿ç”¨threading.<strong>Thread</strong>ç±»å®ä¾‹åŒ–å¯¹è±¡ï¼Œå†è°ƒç”¨<code class="highlighter-rouge">start()</code>æ–¹æ³•è¿è¡Œ</p>

<p><strong>ç¤ºä¾‹ï¼š</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!usr/bin/env python
#coding=utf-8
</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">def</span> <span class="nf">func</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">' start'</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">' end'</span><span class="p">)</span>

<span class="n">t1</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">func</span><span class="p">)</span>   <span class="c1"># åˆ›å»ºçº¿ç¨‹
</span><span class="n">t2</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">func</span><span class="p">)</span>

<span class="n">t1</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>   <span class="c1"># å¼€å§‹çº¿ç¨‹
</span><span class="n">t2</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

<span class="c1"># t1.join()    # ç­‰å¾…è¯¥çº¿ç¨‹ç»“æŸåï¼Œå†å¾€ä¸‹æ‰§è¡Œ
# t2.join()
</span>
<span class="k">print</span><span class="p">(</span><span class="s">'main thread end'</span><span class="p">)</span>    <span class="c1"># ä½¿ç”¨threadingæ¨¡å—Threadç±»çš„çº¿ç¨‹ï¼Œç¨‹åºéœ€è¦ç­‰å¾…å…¨éƒ¨çº¿ç¨‹æ‰§è¡Œå®Œåæ‰é€€å‡º
</span></code></pre></div></div>
<blockquote>
  <p><del>è¾“å‡º</del></p>
  <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Thread-1  start
Thread-2  start
main thread end
Thread-1  end
Thread-2  end
</code></pre></div>  </div>
</blockquote>

<h3 id="ç»§æ‰¿ç±»çš„å½¢å¼">ç»§æ‰¿ç±»çš„å½¢å¼</h3>
<p>é€šè¿‡ç»§æ‰¿threading.Threadç±»ï¼Œå¯ä»¥é‡å†™<code class="highlighter-rouge">run()</code>æ–¹æ³•ï¼Œå†å®ä¾‹åŒ–è¯¥ç±»ï¼Œè°ƒç”¨<code class="highlighter-rouge">start()</code>æ–¹æ³•è¿è¡Œ
<em>ï¼ˆç»§æ‰¿Threadç±»ï¼Œå¹¶ä¸æ˜¯éè¦é‡å†™<code class="highlighter-rouge">run()</code>ï¼‰</em></p>

<p><strong>ç¤ºä¾‹ï¼š</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!usr/bin/env python
#coding=utf-8
</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">class</span> <span class="nc">MyThread</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
    
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s">' start'</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s">' end'</span><span class="p">)</span>

<span class="n">t1</span> <span class="o">=</span> <span class="n">MyThread</span><span class="p">(</span><span class="s">'thread1'</span><span class="p">)</span>
<span class="n">t2</span> <span class="o">=</span> <span class="n">MyThread</span><span class="p">(</span><span class="s">'thread2'</span><span class="p">)</span>

<span class="n">t1</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="n">t2</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

<span class="c1"># t1.join()
# t2.join()
</span>
<span class="k">print</span><span class="p">(</span><span class="s">'main thread end'</span><span class="p">)</span>
</code></pre></div></div>

<blockquote>
  <p><del>è¾“å‡º</del></p>
  <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>thread1 start
thread2 start
main thread end
thread1 end
thread2 end
</code></pre></div>  </div>
</blockquote>

<hr />
<h1 id="çº¿ç¨‹åŒæ­¥">çº¿ç¨‹åŒæ­¥</h1>
<p>å½“å±äºå¹¶å‘çº¿ç¨‹çš„å¤šä¸ªæ“ä½œå°è¯•è®¿é—®å…±äº«å†…å­˜ï¼Œå¹¶ä¸”è‡³å°‘æœ‰ä¸€ä¸ªæ“ä½œèƒ½ä¿®æ”¹æ•°æ®çš„çŠ¶æ€æ—¶ï¼Œè¿™æ—¶å¦‚æœæ²¡æœ‰æ°å½“çš„åŒæ­¥æœºåˆ¶ï¼Œå¯èƒ½ä¼šå‘ç”Ÿæ„å¤–æƒ…å†µæˆ–bugã€‚ä½¿ç”¨<code class="highlighter-rouge">é”</code>å¯ä»¥è§£å†³æ­¤é—®é¢˜ã€‚
å½“ä¸€ä¸ªçº¿ç¨‹æƒ³è¦è®¿é—®å…±äº«å†…å­˜çš„æŸä¸€éƒ¨åˆ†åŒºåŸŸæ—¶ï¼Œå®ƒå¿…é¡»å†ä½¿ç”¨å‰è·å–åˆ°è¯¥éƒ¨åˆ†çš„é”ã€‚å¹¶åœ¨æ“ä½œå®Œåï¼Œè¦é‡Šæ”¾æ‰ä¹‹å‰è·å–åˆ°çš„é”ã€‚</p>

<p><strong>æ³¨æ„!</strong> è¦é¿å…<code class="highlighter-rouge">æ­»é”</code> <sup>4</sup>çš„æƒ…å†µå‘ç”Ÿ</p>

<h2 id="ä½¿ç”¨lockå®ç°çº¿ç¨‹åŒæ­¥">ä½¿ç”¨Lockå®ç°çº¿ç¨‹åŒæ­¥</h2>
<p>ä½¿ç”¨threading.Lock()å®ä¾‹åŒ–Locké”å¯¹è±¡
åœ¨å…±äº«èµ„æºæ“ä½œçš„éƒ¨åˆ†ï¼Œè°ƒç”¨Lockçš„æ–¹æ³•<code class="highlighter-rouge">acquire()</code>è·å–é”
ç»“æŸæ“ä½œåï¼Œè°ƒç”¨Lockçš„æ–¹æ³•<code class="highlighter-rouge">release()</code>é‡Šæ”¾é”ï¼Œä»¥ä¾¿äºå…¶å®ƒçº¿ç¨‹ä½¿ç”¨è¯¥èµ„æº</p>

<p><em>ï¼ˆå‡½æ•°å£°æ˜ï¼š
<strong>acquire</strong>(blocking=True, timeout=-1)
è·å–é”ï¼Œå¹¶é˜»å¡å…¶å®ƒçº¿ç¨‹è®¿é—®è¿™éƒ¨åˆ†èµ„æº
blocking[ <sup>5</sup>: è®¾ç½®ä¸ºFalseçš„çº¿ç¨‹ä¸ä¼šè¢«é˜»å¡ *ï¼ˆå¹¶ä¸”<code class="highlighter-rouge">timeout</code>è®¾ç½®ä¸ºé»˜è®¤å€¼-1æ—¶ï¼Œå¤±å»åŒæ­¥æ•ˆæœã€‚è®¾ç½®ä¸ºé-1å€¼æ—¶ï¼Œè¢«è®¾ç½®ä¸ºTrueçš„çº¿ç¨‹é˜»å¡ï¼Œåˆ™Falseç«‹å³è¿”å›ã€‚è¿™2ç§æƒ…å†µéƒ½ä¼šæç¤ºé”™è¯¯ä¿¡æ¯ï¼‰</em>
timeout: è®¾ç½®ç­‰å¾…çš„è¶…æ—¶å€¼ï¼Œ-1ä¸ºæ— é™ç­‰å¾…ï¼Œè¶…æ—¶åæ— è§†é˜»å¡
è¿”å›å€¼ä¸º<code class="highlighter-rouge">True</code>æˆåŠŸè·å–é”å®šï¼Œ<code class="highlighter-rouge">False</code>åä¹‹ï¼ˆä¾‹å¦‚è¶…æ—¶åˆ°æœŸï¼‰
<strong>release</strong>()
åœ¨æœªé”çš„èµ„æºä¸Šè°ƒç”¨é‡Šæ”¾é”æ–¹æ³•ï¼Œä¼šå¼•å‘<code class="highlighter-rouge">RuntimeError</code>ï¼‰*</p>

<p><strong>ç¤ºä¾‹ï¼š</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!usr/bin/env python
#coding=utf-8
</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>     <span class="c1"># åˆ›å»ºLocké”
</span><span class="n">num</span> <span class="o">=</span> <span class="mi">0</span>     <span class="c1"># ç´¯åŠ è¿™ä¸ªå˜é‡ï¼Œè§‚å¯Ÿä¸åŒæ­¥çš„æƒ…å†µå‡ºç°
</span>
<span class="k">def</span> <span class="nf">func</span><span class="p">():</span>
    <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>  <span class="c1"># è·å–é”
</span>    <span class="k">global</span> <span class="n">num</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000000</span><span class="p">):</span>    <span class="c1"># å¦‚æœæœªå‡ºç°ä¸åŒæ­¥ï¼Œæ˜¯ç”±äºè¿ç®—å¤ªå¿«ï¼ŒåŠ å¤§å¾ªç¯å€¼
</span>        <span class="n">num</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>  <span class="c1"># é‡Šæ”¾é”
</span>
<span class="n">t1</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">func</span><span class="p">)</span>
<span class="n">t2</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">func</span><span class="p">)</span>

<span class="n">t1</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="n">t2</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

<span class="n">t1</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
<span class="n">t2</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

<span class="k">print</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
</code></pre></div></div>

<pre><code class="language-output">æœ‰é”æƒ…å†µä¸‹ï¼Œè¾“å‡ºï¼š
2000000

æ— é”æƒ…å†µä¸‹ï¼Œä¸åŒæ­¥ï¼Œè¾“å‡ºï¼š
ç¬¬ä¸€æ¬¡è¾“å‡ºï¼š
1253312
ç¬¬äºŒæ¬¡è¾“å‡ºï¼š
1227567
ç¬¬ä¸‰æ¬¡è¾“å‡ºï¼š
1309097
&lt;/pre&gt;
</code></pre>

<p><strong>æ³¨!</strong> ä¹¦ä¸­å¹¶ä¸æå€¡ä½¿ç”¨é”æ¥è§£å†³ï¼Œå› ä¸ºå¯èƒ½ä¼šå¯¼è‡´æ­»é”æƒ…å†µå‘ç”Ÿï¼Œä¹Ÿä¼šå¯¹ä»£ç çš„å¯è¯»æ€§äº§ç”Ÿå½±å“ï¼Œè°ƒè¯•å›°éš¾</p>

<h2 id="ä½¿ç”¨rlockå®ç°çº¿ç¨‹åŒæ­¥">ä½¿ç”¨RLockå®ç°çº¿ç¨‹åŒæ­¥</h2>
<p>å¯é‡å…¥é”ï¼ˆreentrant lockï¼‰
æ“ä½œæ–¹å¼åŒLocké”</p>

<p><strong>ä¸Lockçš„åŒºåˆ«</strong>ï¼šRLockåœ¨ <strong>åŒä¸€ä¸ªçº¿ç¨‹ä¸­</strong>å¯ä»¥å¤šæ¬¡<code class="highlighter-rouge">acquire()</code>è·å–é”è€Œä¸å‘ç”Ÿé˜»å¡ <em>ï¼ˆè¿™æ˜¯ä¸ºäº†è§£å†³ä¸€äº›ç‰¹æ®Šåœºæ™¯çš„ä½¿ç”¨ï¼‰</em></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># éƒ¨åˆ†ä»£ç 
</span><span class="n">lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">RLock</span><span class="p">()</span>     <span class="c1"># åˆ›å»ºRLocké”
</span>
<span class="k">def</span> <span class="nf">func</span><span class="p">():</span>
    <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>  <span class="c1"># è·å–é”
</span>    <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
    <span class="k">global</span> <span class="n">num</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000000</span><span class="p">):</span>
        <span class="n">num</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>  <span class="c1"># é‡Šæ”¾é”
</span>    <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</code></pre></div></div>

<p><strong>æ³¨æ„!</strong> acquire()éœ€è¦æˆå¯¹ä½¿ç”¨</p>

<h2 id="ä½¿ç”¨ä¿¡å·é‡å®ç°çº¿ç¨‹åŒæ­¥">ä½¿ç”¨ä¿¡å·é‡å®ç°çº¿ç¨‹åŒæ­¥</h2>

<p><strong>ä¿¡å·é‡</strong>çš„æå‡ºï¼Œé¦–æ¬¡ç”¨åœ¨æ“ä½œç³»ç»Ÿä¸­ã€‚å®ƒæ˜¯ä¸€ä¸ªæ“ä½œç³»ç»Ÿç®¡ç†çš„æŠ½è±¡æ•°æ®ç±»å‹ï¼Œç”¨äºåŒæ­¥å¤šä¸ªçº¿ç¨‹å¯¹å…±äº«èµ„æºä¸æ•°æ®çš„è®¿é—®
<em>ï¼ˆæœ¬è´¨ä¸Šï¼Œä¿¡å·é‡æ˜¯ç”±ä¸€ä¸ªå†…éƒ¨å˜é‡æ„æˆçš„ï¼Œå®ƒæ ‡è¯†å‡ºäº†å¯¹å…¶æ‰€å…³è”çš„èµ„æºçš„å¹¶å‘è®¿é—®é‡ï¼‰</em></p>

<p>ä½¿ç”¨threading.<strong>Semaphore</strong>()åˆ›å»ºå¯¹è±¡
åœ¨çº¿ç¨‹æ¨¡å—ä¸­ï¼Œä¿¡å·é‡çš„æ“ä½œåŸºäº<code class="highlighter-rouge">acquire()</code>ä¸<code class="highlighter-rouge">release()</code></p>

<p>å½“ä¸€ä¸ªçº¿ç¨‹æƒ³ä½¿ç”¨ä¸€ä¸ªèµ„æºï¼Œå®ƒéœ€è¦è°ƒç”¨<code class="highlighter-rouge">acquire()</code>ï¼Œä¼šåˆ¤æ–­ä¿¡å·é‡å†…éƒ¨å˜é‡å€¼_valueï¼Œå¦‚æœä¸º0åˆ™é˜»å¡çº¿ç¨‹ï¼Œå¹¶ä¸”è¿›è¡Œtimeoutè¶…æ—¶å¤„ç†ï¼Œå¦‚æœ_valueä¸ä¸º0ï¼Œçº¿ç¨‹è¿è¡Œ <em>ï¼ˆç”±äºä¿¡å·é‡çš„åˆå§‹å€¼ä¸ºéè´Ÿæ•°ï¼Œæ•…è®¾è®¡ä¸­ä¸å­˜åœ¨è´Ÿæ•°æƒ…å†µçš„ä»£ç ï¼‰</em>
å½“ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨å®Œä¸€ä¸ªèµ„æºåï¼Œå®ƒéœ€è¦è°ƒç”¨<code class="highlighter-rouge">release()</code>ï¼Œè¯¥æ“ä½œä¼šå¢åŠ ä¿¡å·é‡çš„å†…éƒ¨å˜é‡å€¼ï¼Œå¹¶é€šçŸ¥ç­‰å¾…çš„çº¿ç¨‹
<em>ï¼ˆ <strong>æ³¨!</strong> ä¹¦ä¸­çš„æè¿°å’Œthreadingæ¨¡å—çš„æºç ä¸ç¬¦ï¼Œé‡æ–°æŒ‰æºç çš„ç†è§£å†™ï¼‰</em></p>

<p><strong>æ³¨æ„!</strong> <code class="highlighter-rouge">acquire()</code>å’Œ<code class="highlighter-rouge">release()</code>å¹¶ä¸éœ€è¦æ”¾åœ¨æŸæ®µä»£ç çš„å‰åï¼Œæ¥é”ä½æŸæ®µèµ„æº</p>

<p><strong>ç¤ºä¾‹ï¼š</strong></p>

<p><em>ï¼ˆç”±äºä¹¦ä¸­ç»™çš„ç¤ºä¾‹ä»£ç ï¼Œæ„Ÿè§‰å¾ˆç¬¦åˆç†è§£ä¿¡å·é‡çš„ç‰¹ç‚¹ï¼Œè¿™é‡Œä¹Ÿé‡‡ç”¨ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„å…³ç³»ç¼–å†™ä»£ç ï¼‰</em></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!usr/bin/env python
#coding=utf-8
</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="c1"># å¯é€‰å‚æ•°ä¸ºå†…éƒ¨å˜é‡_valueèµ‹åˆå€¼ï¼Œé»˜è®¤ä¸º1
# å¦‚æœèµ‹çš„å€¼å°äº0ï¼Œä¼šraise ValueErrorå¼‚å¸¸
</span><span class="n">sem</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Semaphore</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">producer</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">item</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">item</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'producer: produced'</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
    <span class="n">sem</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>   <span class="c1"># é‡Šæ”¾ä¿¡å·é‡ï¼Œå°†å†…éƒ¨_valueåŠ 1ï¼Œå¹¶é€šçŸ¥å…¶å®ƒç­‰å¾…çš„çº¿ç¨‹
</span>
<span class="k">def</span> <span class="nf">consumer</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'consumer is waiting'</span><span class="p">)</span>
    <span class="n">sem</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>   <span class="c1"># è·å–ä¿¡å·é‡ï¼Œå€¼ç­‰äº0åˆ™é˜»å¡çº¿ç¨‹ï¼Œå¦åˆ™å†…éƒ¨_valueå‡1ï¼Œå¹¶ç»§ç»­è¿è¡Œ
</span>    <span class="k">print</span><span class="p">(</span><span class="s">'consumer: sonsumed'</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>

<span class="n">t1</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">producer</span><span class="p">)</span>
<span class="n">t2</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">consumer</span><span class="p">)</span>

<span class="n">t1</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="n">t2</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</code></pre></div></div>

<blockquote>
  <p><del>è¾“å‡º</del></p>
  <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>consumer is waiting
producer: produced 295
consumer: sonsumed  295
</code></pre></div>  </div>

  <p><em><del>åˆ†æï¼šå¤šæ‰§è¡Œå‡ æ¬¡ï¼Œé€»è¾‘ä¸Šå¯ä»¥å‘ç°æ¶ˆè´¹è€…æ€»éœ€è¦ç­‰å¾…ç”Ÿäº§è€…ç”Ÿäº§å‡ºäº§å“åï¼Œæ‰èƒ½æ¶ˆè´¹</del></em></p>
</blockquote>

<p>å¯ä»¥çœ‹å‡ºä¿¡å·é‡å¾ˆé€‚åˆè¿™æ ·çš„åœºæ™¯ï¼Œä¸‹é¢å¯ä»¥æµ‹è¯•ï¼Œç”Ÿäº§è€…å¯ä»¥å¤šç”Ÿäº§å‡ ä¸ªï¼Œæ¶ˆè´¹è€…å†æ¶ˆè´¹</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> import threading
<span class="o">&gt;&gt;&gt;</span> sem <span class="o">=</span> threading.Semaphore<span class="o">()</span>
<span class="o">&gt;&gt;&gt;</span> sem.acquire<span class="o">()</span>    <span class="c"># è·å–åˆå§‹åŒ–çš„ä¿¡å·é‡</span>
True
<span class="o">&gt;&gt;&gt;</span> sem.release<span class="o">()</span>    <span class="c"># ä¿¡å·é‡+1</span>
<span class="o">&gt;&gt;&gt;</span> sem.release<span class="o">()</span>    <span class="c"># ä¿¡å·é‡+1</span>
<span class="o">&gt;&gt;&gt;</span> sem.release<span class="o">()</span>    <span class="c"># ä¿¡å·é‡+1</span>
<span class="o">&gt;&gt;&gt;</span> sem.acquire<span class="o">()</span>    <span class="c"># ä¿¡å·é‡-1</span>
True
<span class="o">&gt;&gt;&gt;</span> sem.acquire<span class="o">()</span>    <span class="c"># ä¿¡å·é‡-1</span>
True
<span class="o">&gt;&gt;&gt;</span> sem.acquire<span class="o">()</span>    <span class="c"># ä¿¡å·é‡-1</span>
True
<span class="o">&gt;&gt;&gt;</span> sem.acquire<span class="o">()</span>    <span class="c"># ç”±äºä¿¡å·é‡=0</span>
    <span class="c"># æ‰€ä»¥é™·å…¥äº†é˜»å¡</span>
</code></pre></div></div>

<h2 id="ä½¿ç”¨æ¡ä»¶å®ç°çº¿ç¨‹åŒæ­¥">ä½¿ç”¨æ¡ä»¶å®ç°çº¿ç¨‹åŒæ­¥</h2>
<p>ä½¿ç”¨threading.<strong>Condition</strong>()åˆ›å»ºå¯¹è±¡</p>

<p>æŸ¥çœ‹Conditionçš„æºç ï¼Œå‘ç°å¯ä»¥ä¼ å…¥ä¸€ä¸ªé”ä½œä¸ºåˆå§‹åŒ–å‚æ•°ã€‚å¦‚æœä¸ä¼ ï¼Œé»˜è®¤ä¼šèµ‹å€¼<code class="highlighter-rouge">RLock</code>é”æ¥è¿›è¡Œåç»­çš„é”çš„æ“ä½œ <em>ï¼ˆ<code class="highlighter-rouge">acquire()</code>ã€<code class="highlighter-rouge">release()</code>ï¼‰</em></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Conditionç±»çš„åˆå§‹åŒ–éƒ¨åˆ†æºç 
</span>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lock</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">lock</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">lock</span> <span class="o">=</span> <span class="n">RLock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">lock</span>
        <span class="c1"># Export the lock's acquire() and release() methods
</span>        <span class="bp">self</span><span class="o">.</span><span class="n">acquire</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="n">release</span>
        <span class="o">...</span>
</code></pre></div></div>

<p><strong>ç¤ºä¾‹ï¼š</strong></p>

<p><em>ï¼ˆä¸‹ä¾‹è¿˜æ˜¯ä½¿ç”¨ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„å…³ç³»ç¼–å†™ç¤ºä¾‹ä»£ç ï¼Œç”¨itemsä½œä¸ºå­˜å‚¨å®¹å™¨ï¼Œä»¥æ»¡äº†(10ä¸ª)å°±ä¸èƒ½å†ç”Ÿäº§ä½œä¸ºæ¡ä»¶ï¼Œä»¥æ²¡äº†(0ä¸ª)å°±ä¸èƒ½å†æ¶ˆè´¹ä½œä¸ºæ¡ä»¶ï¼‰</em></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!usr/bin/env python
#coding=utf-8
</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">condition</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Condition</span><span class="p">()</span>   <span class="c1"># åˆ›å»ºæ¡ä»¶
</span><span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>      <span class="c1"># ä½œä¸ºäº§å“çš„å­˜å‚¨å®¹å™¨ï¼Œè®¾è¾¾åˆ°10ä¸ªä¸ºæ»¡äº†ï¼Œå°±ä¸èƒ½å†ç”Ÿäº§äº†
</span>
<span class="k">def</span> <span class="nf">producer</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">items</span>
    <span class="n">condition</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>     <span class="c1"># è·å–é”
</span>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">==</span> <span class="mi">10</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'producer: stop produce'</span><span class="p">)</span>
        <span class="n">condition</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>    <span class="c1"># ç­‰å¾…(itemsè¾¾åˆ°10ï¼Œç­‰å¾…æ¶ˆè´¹è€…æ¶ˆè´¹)
</span>    <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">''</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'producer: produced'</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">))</span>
    <span class="n">condition</span><span class="o">.</span><span class="n">notify</span><span class="p">()</span>      <span class="c1"># é€šçŸ¥ç­‰å¾…çš„çº¿ç¨‹
</span>    <span class="n">condition</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>     <span class="c1"># é‡Šæ”¾é”
</span>    
<span class="k">def</span> <span class="nf">consumer</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">items</span>
    <span class="n">condition</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>     <span class="c1"># è·å–é”
</span>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'consumer: waiting'</span><span class="p">)</span>
        <span class="n">condition</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>    <span class="c1"># ç­‰å¾…(itemsä¸º0ï¼Œç­‰å¾…ç”Ÿäº§è€…ç”Ÿäº§)
</span>    <span class="n">items</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>       <span class="c1"># æ³¨! æ³¨é‡Šæ‰è¿™è¡Œï¼Œä¼šå‘ç°ï¼Œç­‰å¾…wait()åœ¨æ¥æ”¶åˆ°é€šçŸ¥notify()åï¼Œå¹¶æ²¡æœ‰å†æ¬¡åˆ¤æ–­æ¡ä»¶ï¼Œç›´æ¥å°±æ¥ç€è¿è¡Œäº†
</span>    <span class="k">print</span><span class="p">(</span><span class="s">'consumer: sonsumed'</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">))</span>
    <span class="n">condition</span><span class="o">.</span><span class="n">notify</span><span class="p">()</span>      <span class="c1"># é€šçŸ¥ç­‰å¾…çš„çº¿ç¨‹
</span>    <span class="n">condition</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>     <span class="c1"># é‡Šæ”¾é”
</span>

<span class="c1"># producer_loop()å’Œconsumer_loop()ç”¨æ¥å¤šæ¬¡å¾ªç¯è¿è¡Œï¼Œä¸ºäº†è¾¾åˆ°itemsä¸º0æˆ–10çš„æƒ…å†µ
</span><span class="k">def</span> <span class="nf">producer_loop</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">producer</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">consumer_loop</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">consumer</span><span class="p">()</span>


<span class="n">t1</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">producer_loop</span><span class="p">)</span>
<span class="n">t2</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">consumer_loop</span><span class="p">)</span>

<span class="n">t1</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="n">t2</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</code></pre></div></div>

<blockquote>
  <p><del>è¾“å‡º</del></p>
  <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>producer: produced 1
producer: produced 2
producer: produced 3
consumer: sonsumed 2
producer: produced 3
producer: produced 4
producer: produced 5
producer: produced 6
consumer: sonsumed 5
producer: produced 6
producer: produced 7
producer: produced 8
producer: produced 9
consumer: sonsumed 8
producer: produced 9
producer: produced 10
producer: stop produce
consumer: sonsumed 9
producer: produced 10
producer: stop produce
consumer: sonsumed 9
producer: produced 10
producer: stop produce
consumer: sonsumed 9
producer: produced 10
producer: stop produce
consumer: sonsumed 9
producer: produced 10
producer: stop produce
consumer: sonsumed 9
producer: produced 10
producer: stop produce
consumer: sonsumed 9
producer: produced 10
producer: stop produce
consumer: sonsumed 9
producer: produced 10
consumer: sonsumed 9
consumer: sonsumed 8
consumer: sonsumed 7
consumer: sonsumed 6
consumer: sonsumed 5
consumer: sonsumed 4
consumer: sonsumed 3
consumer: sonsumed 2
consumer: sonsumed 1
consumer: sonsumed 0
</code></pre></div>  </div>

  <p><em><del>åˆ†æï¼šè§‚å¯Ÿå¯ä»¥å‘ç°ï¼Œç”Ÿäº§è€…ç”Ÿäº§æ»¡äº†10ä¸ªå°±ä¼šè¿›å…¥ç­‰å¾…<code class="highlighter-rouge">wait()</code>ï¼Œç›´åˆ°æ¶ˆè´¹è€…é€šçŸ¥<code class="highlighter-rouge">notify()</code></del>
<del>ä¸ºäº†è§‚å¯Ÿæ¶ˆè´¹è€…æ¶ˆè´¹åˆ°0ä¸ªçš„æƒ…å†µï¼Œå¯ä»¥å°†ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…å¾ªç¯çš„ç­‰å¾…æ—¶é—´åšè°ƒæ•´</del></em></p>
</blockquote>

<h2 id="ä½¿ç”¨äº‹ä»¶å®ç°çº¿ç¨‹åŒæ­¥">ä½¿ç”¨äº‹ä»¶å®ç°çº¿ç¨‹åŒæ­¥</h2>
<p>æŸ¥çœ‹Eventç±»çš„æºç ï¼Œå‘ç°å†…éƒ¨ä½¿ç”¨çš„æ˜¯æ¡ä»¶<code class="highlighter-rouge">Condition</code>ç±»å®ç°ï¼Œå¹¶ä¼ å…¥äº†<code class="highlighter-rouge">Lock</code>é”ã€‚äº‹ä»¶é€šè¿‡å¯¹å†…éƒ¨çš„<strong>æ ‡å¿—_flag</strong>è¿›è¡Œç®¡ç†æ¥å®ç°çº¿ç¨‹åŒæ­¥
ä½¿ç”¨<code class="highlighter-rouge">set()</code>æ–¹æ³•å¯ä»¥å°†æ ‡å¿—è®¾ä¸ºTrue
ä½¿ç”¨<code class="highlighter-rouge">clear()</code>æ–¹æ³•å°†å…¶é‡ç½®ä¸ºFalse
ä½¿ç”¨<code class="highlighter-rouge">wait()</code>æ–¹æ³•é˜»å¡çº¿ç¨‹</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Eventç±»çš„åˆå§‹åŒ–æºç 
</span>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cond</span> <span class="o">=</span> <span class="n">Condition</span><span class="p">(</span><span class="n">Lock</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_flag</span> <span class="o">=</span> <span class="bp">False</span>
</code></pre></div></div>

<p><strong>æ³¨æ„!</strong> å¹¶ä¸å­˜åœ¨<code class="highlighter-rouge">set()</code>å’Œ<code class="highlighter-rouge">clear()</code>æ”¾åœ¨æŸæ®µä»£ç çš„å‰åï¼Œæ¥é”ä½æŸæ®µèµ„æº</p>

<p><strong>ç¤ºä¾‹ï¼š</strong>
<em>ï¼ˆè¿˜æ˜¯é‡‡ç”¨ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„å…³ç³»ç¼–å†™ï¼Œç”Ÿäº§è€…åšå®Œå·¥ä½œï¼Œè°ƒç”¨<code class="highlighter-rouge">set()</code>è®¾ç½®<code class="highlighter-rouge">_flag</code>æ ‡å¿—ï¼Œå¹¶é€šçŸ¥<code class="highlighter-rouge">wait()</code>ç­‰å¾…çš„æ¶ˆè´¹è€…çº¿ç¨‹è¿è¡Œï¼›å†ä½¿ç”¨<code class="highlighter-rouge">clear()</code>æ¸…é™¤<code class="highlighter-rouge">_flag</code>æ ‡å¿—ï¼Œä»¥ä¾¿åé¢çš„æ¶ˆè´¹è€…èƒ½æ­£ç¡®çš„è¿›å…¥ç­‰å¾…ã€‚è¿™ä¸ªè¿‡ç¨‹ç±»ä¼¼äºäº‹ä»¶çš„è§¦å‘ï¼‰</em></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!usr/bin/env python
#coding=utf-8
</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="n">event</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>   <span class="c1"># åˆ›å»ºäº‹ä»¶
</span><span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="c1"># è®¾ç½®ä¸ªåˆå€¼ï¼Œä¾¿äºåé¢æ³¨é‡Ševent.clear()åçš„æµ‹è¯•(å¯ä»¥å‘ç°,æ¶ˆè´¹è€…ä¸ç­‰å¾…äº†)
</span>
<span class="k">def</span> <span class="nf">producer</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">items</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'producer: start'</span><span class="p">)</span>
    <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">100</span><span class="p">))</span>
    <span class="n">event</span><span class="o">.</span><span class="nb">set</span><span class="p">()</span>     <span class="c1"># å°†å†…éƒ¨æ ‡å¿—_flagè®¾ä¸ºTrue,å¹¶é€šçŸ¥æ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹(ç±»ä¼¼äºè§¦å‘äº‹ä»¶)
</span>    <span class="k">print</span><span class="p">(</span><span class="s">'producer: notify'</span><span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>   <span class="c1"># å°†å†…éƒ¨æ ‡å¿—_flagè®¾ä¸ºFalse(åªæœ‰æ¸…é™¤äº†_flag,æ¶ˆè´¹è€…ä¸‹ä¸€æ¬¡çš„wait()æ“ä½œæ‰ä¼šæ­£å¸¸è¿›å…¥ç­‰å¾…)(clear()æ“ä½œä¹Ÿå¯ä»¥äº¤ç»™æ¶ˆè´¹è€…è°ƒç”¨ï¼Œä¸è¿‡ä¸ºäº†ç®€åŒ–æ¶ˆè´¹è€…çš„æ“ä½œï¼Œè®©æ¶ˆè´¹è€…åªéœ€è¦ç­‰å¾…é€šçŸ¥å³å¯)
</span>    <span class="k">print</span><span class="p">(</span><span class="s">'producer: end'</span><span class="p">)</span>
    
<span class="k">def</span> <span class="nf">consumer</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">items</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'consumer: waiting'</span><span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>    <span class="c1"># ç­‰å¾…(ç­‰å¾…ç”Ÿäº§è€…é€šçŸ¥,æ ¹æ®_flagæ ‡å¿—åˆ¤æ–­æ˜¯å¦è¿›å…¥ç­‰å¾…)
</span>    <span class="k">print</span><span class="p">(</span><span class="s">'consumer:'</span><span class="p">,</span> <span class="n">items</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>


<span class="c1"># producer_loop()å’Œconsumer_loop()ç”¨æ¥å¤šæ¬¡å¾ªç¯è¿è¡Œ
</span><span class="k">def</span> <span class="nf">producer_loop</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">producer</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">consumer_loop</span><span class="p">():</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span> <span class="c1"># æ¶ˆè´¹è€…æœ‰wait()ç­‰å¾…ï¼Œå°±ä¸ç”¨çº¿ç¨‹ä¼‘çœ äº†ï¼Œä»¥å…é”™è¿‡ç”Ÿäº§è€…çš„set()é€šçŸ¥
</span>        <span class="n">consumer</span><span class="p">()</span>


<span class="n">t1</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">producer_loop</span><span class="p">)</span>
<span class="n">t2</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">consumer_loop</span><span class="p">)</span>

<span class="n">t1</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="n">t2</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</code></pre></div></div>

<blockquote>
  <p><del>è¾“å‡º</del></p>
  <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>consumer: waiting
producer: start
producer: notify
consumer: 57
consumer: waiting
producer: end
producer: start
producer: notify
consumer: 10
producer: end
consumer: waiting
producer: start
producer: notify
consumer: 24
producer: end
consumer: waiting
</code></pre></div>  </div>
</blockquote>

<blockquote>
  <p><del>å¦‚æœæ³¨é‡Šæ‰ä»£ç ä¸­çš„<code class="highlighter-rouge"># event.clear()</code>ä¸€è¡Œï¼Œä¼šå‡ºç°å¦‚ä¸‹è¾“å‡º</del></p>
  <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>consumer: waiting
producer: start
producer: notify
consumer: 19
producer: end
consumer: waiting
consumer: 3
consumer: waiting
consumer: 2
consumer: waiting
consumer: 1
consumer: waiting
Exception in thread Thread-2:
Traceback (most recent call last):
  File "D:\app\Python\Python37\lib\threading.py", line 917, in _bootstrap_inner
    self.run()
  File "D:\app\Python\Python37\lib\threading.py", line 865, in run
    self._target(*self._args, **self._kwargs)
  File "g:/tmp/code.py", line 35, in consumer_loop
    consumer()
  File "g:/tmp/code.py", line 24, in consumer
    print('consumer:', items.pop())
IndexError: pop from empty list
</code></pre></div>  </div>

  <p>producer: start</p>
  <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>producer: notify
producer: end
producer: start
producer: notify
producer: end
</code></pre></div>  </div>

  <p><em><del>åˆ†æï¼šä¼šå‘ç°ï¼Œæ¶ˆè´¹è€…æ²¡æœ‰ç­‰å¾…(æ‰“å°å‡ºçš„consumer: waitingï¼Œåªæ˜¯ç»™è‡ªå·±çš„æç¤ºï¼Œå®é™…æ²¡æœ‰ç­‰å¾…)ï¼Œç›´æ¥è¿›è¡Œäº†åˆ—è¡¨çš„<code class="highlighter-rouge">pop()</code>æ“ä½œï¼Œç›´åˆ°åé¢åˆ—è¡¨ä¸ºç©ºå†å¼¹å‡ºæ—¶æŠ¥é”™ä¸ºæ­¢</del></em></p>
</blockquote>

<hr />
<h1 id="é™„å…¶å®ƒ">é™„ï¼šå…¶å®ƒ</h1>
<h2 id="ä½¿ç”¨withè¯­å¥-6">ä½¿ç”¨withè¯­å¥ <sup>6</sup></h2>
<p><em>ï¼ˆç”±äºæ²¡æœ‰ç†è§£éƒ¨åˆ†ï¼Œè¿™ä¸€éƒ¨åˆ†åŸºæœ¬å°±æ˜¯ä¹¦ä¸­åŸæ–‡ï¼‰</em></p>

<p><strong>with</strong>: æ˜¯Python 2.5ä¸­å¼•å…¥çš„ã€‚å½“æœ‰ä¸¤ä¸ªç›¸å…³çš„æ“ä½œéœ€è¦å¯¹ä¸€ä¸ªä»£ç å—æ‰¿å…‘æ‰§è¡Œæ—¶ï¼Œwithè¯­å¥çš„ä½œç”¨å°±å½°æ˜¾å‡ºæ¥äº†ã€‚å®ƒå¯ä»¥å†è‡ªåŠ¨ç²¾ç¡®çš„åˆ†é…æˆ–é‡Šæ”¾èµ„æº <em>ï¼ˆå› æ­¤ä¹Ÿè¢«ç§°ä¸ºä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼‰</em>ã€‚å¦‚çº¿ç¨‹æ¨¡å—ä¸­ï¼Œä½¿ç”¨åˆ°<code class="highlighter-rouge">acquire()</code>å’Œ<code class="highlighter-rouge">release()</code>æ–¹æ³•çš„åœ°æ–¹ï¼Œéƒ½å¯ä»¥é‡‡ç”¨<code class="highlighter-rouge">with</code>è¯­å¥å—ï¼Œå¦‚ä¸‹ï¼š</p>
<blockquote>
  <ul>
    <li>Lock</li>
    <li>RLock</li>
    <li>æ¡ä»¶</li>
    <li>ä¿¡å·é‡ <em>ï¼ˆæ„Ÿè§‰è¿™ç”¨äº†<code class="highlighter-rouge">with</code>å°±ä¸å¤ªçµæ´»äº†ï¼‰</em></li>
  </ul>
</blockquote>

<p><strong>ç¤ºä¾‹ï¼š</strong>
<em>ï¼ˆä¼šæµ‹è¯•ä¸Šè¿°åˆ—è¡¨ä¸­çš„withæ“ä½œï¼‰</em></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!usr/bin/env python
#coding=utf-8
</span>
<span class="kn">import</span> <span class="nn">threading</span>

<span class="k">def</span> <span class="nf">func_with</span><span class="p">(</span><span class="n">statement</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">statement</span><span class="p">:</span> <span class="c1"># ä¼šè‡ªåŠ¨è¿›è¡Œacquire()å’Œrelease()
</span>        <span class="k">print</span><span class="p">(</span><span class="s">'//todo1'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">func_not_with</span><span class="p">(</span><span class="n">statement</span><span class="p">):</span>
    <span class="n">statement</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>    <span class="c1"># ä¸ºäº†é¿å…å‡ºç°å¼‚å¸¸ï¼Œå¯¼è‡´æ²¡æœ‰release()é‡Šæ”¾
</span>        <span class="k">print</span><span class="p">(</span><span class="s">'//todo2'</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">statement</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

<span class="n">lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
<span class="n">rlock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">RLock</span><span class="p">()</span>
<span class="n">condition</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Condition</span><span class="p">()</span>
<span class="n">sem</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Semaphore</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>    <span class="c1"># é‡‡ç”¨withï¼Œéœ€è¦åˆå§‹è‡³å°‘æœ‰ä¸€ä¸ªä¿¡å·é‡å€¼ï¼ˆå› ä¸ºéœ€è¦å…ˆacquire()ï¼‰
</span>
<span class="n">li</span> <span class="o">=</span> <span class="p">[</span><span class="n">lock</span><span class="p">,</span> <span class="n">rlock</span><span class="p">,</span> <span class="n">condition</span><span class="p">,</span> <span class="n">sem</span><span class="p">]</span>

<span class="k">for</span> <span class="n">statement</span> <span class="ow">in</span> <span class="n">li</span><span class="p">:</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">func_with</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">statement</span><span class="p">,))</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">func_not_with</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">statement</span><span class="p">,))</span>

    <span class="n">t1</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">t2</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</code></pre></div></div>

<h2 id="ä½¿ç”¨é˜Ÿåˆ—å®ç°çº¿ç¨‹é€šä¿¡">ä½¿ç”¨é˜Ÿåˆ—å®ç°çº¿ç¨‹é€šä¿¡</h2>
<p>è™½ç„¶pythonçº¿ç¨‹æ¨¡å—æä¾›äº†å¾ˆå¤šåŒæ­¥åŸè¯­ <em>ï¼ˆ<code class="highlighter-rouge">é”</code>ã€<code class="highlighter-rouge">ä¿¡å·é‡</code>ã€<code class="highlighter-rouge">æ¡ä»¶</code>ã€<code class="highlighter-rouge">äº‹ä»¶</code>ï¼‰</em>ï¼Œä½†æœ‰æ—¶å€™ï¼Œåœ¨ä½¿ç”¨åœºæ™¯ä¸­ï¼Œå¯èƒ½é‡‡ç”¨é˜Ÿåˆ—æ¨¡å—ä¼šæ˜¯ä¸ªæœ€ä½³é€‰æ‹©ã€‚å®ƒä½¿å¾—çº¿ç¨‹ç¼–ç¨‹å˜å¾—æ›´åŠ å®¹æ˜“å’Œå®‰å…¨</p>

<p>ä½¿ç”¨é˜Ÿåˆ—<code class="highlighter-rouge">Queue</code>çš„æ–¹å¼å¤„ç†ï¼Œå°½ç®¡å®ƒä¸å±äº<code class="highlighter-rouge">threading</code>æ¨¡å—ï¼Œä½†æŸ¥çœ‹å…¶æºç ï¼Œå‘ç°é˜Ÿåˆ—çš„åŠŸèƒ½å®ç°æœ‰ç”¨åˆ°<code class="highlighter-rouge">threading</code>æ¨¡å—</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Queueçš„åˆå§‹åŒ–æºç 
    def __init__(self, maxsize=0):
        self.maxsize = maxsize
        self._init(maxsize)

        # mutex must be held whenever the queue is mutating.  All methods
        # that acquire mutex must release it before returning.  mutex
        # is shared between the three conditions, so acquiring and
        # releasing the conditions also acquires and releases mutex.
        self.mutex = threading.Lock()

        # Notify not_empty whenever an item is added to the queue; a
        # thread waiting to get is notified then.
        self.not_empty = threading.Condition(self.mutex)

        # Notify not_full whenever an item is removed from the queue;
        # a thread waiting to put is notified then.
        self.not_full = threading.Condition(self.mutex)

        # Notify all_tasks_done whenever the number of unfinished tasks
        # drops to zero; thread waiting to join() is notified to resume
        self.all_tasks_done = threading.Condition(self.mutex)
        self.unfinished_tasks = 0
</code></pre></div></div>

<p><code class="highlighter-rouge">Queue</code>ä¼šç”¨åˆ°å¦‚ä¸‹æ–¹æ³•ï¼š</p>
<blockquote>
  <ul>
    <li><strong>put</strong>(): æ·»åŠ ä¸€ä¸ªé¡¹ç›®åˆ°é˜Ÿåˆ—</li>
    <li><strong>get</strong>(): ä»é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªé¡¹ç›®</li>
    <li><strong>task_done</strong>(): æ¯å¤„ç†å®Œä¸€ä¸ªé¡¹ç›®ï¼Œéœ€è¦è°ƒç”¨è¯¥æ–¹æ³•</li>
    <li><strong>join</strong>(): é˜»å¡çº¿ç¨‹ï¼Œç­‰å¾…å…¨éƒ¨çš„ä»»åŠ¡å®Œæˆ</li>
  </ul>
</blockquote>

<blockquote>
  <p><em>é™„ï¼šæŸ¥çœ‹æºä»£ç ï¼Œåˆ†æå¯å¾—Queueå†…éƒ¨çš„æ“ä½œæ˜¯è¿™æ ·çš„ï¼šï¼ˆè¿™æ®µå¯ä»¥ä¸ç”¨çœ‹ï¼‰</em></p>
  <ul>
    <li><em>è°ƒç”¨<code class="highlighter-rouge">put()</code> -&gt; withé˜Ÿåˆ—æ»¡(æ¡ä»¶é”<code class="highlighter-rouge">not_full</code>) -&gt; èƒ½é˜»å¡ï¼Ÿ(å‚æ•°block) &amp; èƒ½è¶…æ—¶ï¼Ÿ(å‚æ•°timeout) &amp; éœ€è¦ç­‰å¾…ï¼Ÿ(æ¡ä»¶é”<code class="highlighter-rouge">not_full.wait()</code>) -&gt; æ·»åŠ æ•°æ®(å†…éƒ¨æ–¹æ³•<code class="highlighter-rouge">_put()</code>) -&gt; ä»»åŠ¡è®¡æ•°åŠ 1(å†…éƒ¨è®¡æ•°å˜é‡<code class="highlighter-rouge">unfinished_tasks += 1</code>) -&gt; å‘èµ·é˜Ÿåˆ—éç©ºçš„é€šçŸ¥(æ¡ä»¶é”<code class="highlighter-rouge">not_empty.notify()</code>)</em></li>
    <li><em>è°ƒç”¨<code class="highlighter-rouge">get()</code> -&gt; withé˜Ÿåˆ—ç©º(æ¡ä»¶é”<code class="highlighter-rouge">not_empty</code>) -&gt; èƒ½é˜»å¡ï¼Ÿ(å‚æ•°block) &amp; èƒ½è¶…æ—¶ï¼Ÿ(å‚æ•°timeout) &amp; éœ€è¦ç­‰å¾…ï¼Ÿ(æ¡ä»¶é”<code class="highlighter-rouge">not_empty.wait()</code>) -&gt; å–å‡ºæ•°æ®(å†…éƒ¨æ–¹æ³•<code class="highlighter-rouge">_get()</code>) -&gt; å‘èµ·é˜Ÿåˆ—éæ»¡çš„é€šçŸ¥(æ¡ä»¶é”<code class="highlighter-rouge">not_full.notify()</code>) ï¼ˆ <strong>æ³¨æ„!</strong> <code class="highlighter-rouge">get()</code>ä¸<code class="highlighter-rouge">put()</code>æ“ä½œç›¸æ¯”å¹¶æ²¡æœ‰å¯¹ä»»åŠ¡è®¡æ•°æ“ä½œï¼Œéœ€è¦é€šè¿‡åé¢<code class="highlighter-rouge">task_done()</code>å®Œæˆä»»åŠ¡æ–¹æ³•æ¥å‡å°‘ä»»åŠ¡æ•°ï¼‰</em></li>
    <li>*è°ƒç”¨<code class="highlighter-rouge">task_done()</code> -&gt; withä»»åŠ¡å®Œæˆ(æ¡ä»¶é”<code class="highlighter-rouge">all_tasks_done</code>) -&gt; åˆ¤æ–­å…¨éƒ¨ä»»åŠ¡å®Œæˆäº†ï¼Ÿæ˜¯çš„è¯å‘èµ·é€šçŸ¥(æ¡ä»¶é”<code class="highlighter-rouge">all_tasks_done.notify_all()</code>) -&gt; ä»»åŠ¡è®¡æ•°å‡1(å†…éƒ¨è®¡æ•°å˜é‡<code class="highlighter-rouge">unfinished_tasks -= 1</code>) *</li>
    <li>
      <table>
        <tbody>
          <tr>
            <td>*è°ƒç”¨<code class="highlighter-rouge">join()</code> -&gt; withä»»åŠ¡å®Œæˆ(æ¡ä»¶é”<code class="highlighter-rouge">all_tasks_done</code>) -&gt; å¾ªç¯æœªå®Œæˆçš„ä»»åŠ¡è®¡æ•°å˜é‡(å†…éƒ¨è®¡æ•°å˜é‡<code class="highlighter-rouge">unfinished_tasks</code>) -&gt; è¿˜æœ‰æ²¡å®Œæˆçš„ä»»åŠ¡ï¼Œç­‰å¾…(æ¡ä»¶é”<code class="highlighter-rouge">all_tasks_done.wait()</code></td>
            <td>å…¨éƒ¨å®Œæˆï¼Œé€€å‡ºå¾ªç¯ï¼Œè§£é™¤çº¿ç¨‹é˜»å¡)*</td>
          </tr>
        </tbody>
      </table>
    </li>
  </ul>
</blockquote>

<p><strong>ç¤ºä¾‹ï¼š</strong></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!usr/bin/env python
#coding=utf-8
</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">from</span> <span class="nn">queue</span> <span class="kn">import</span> <span class="n">Queue</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="n">queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">producer</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'producer:'</span><span class="p">,</span> <span class="s">'put'</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">consumer</span><span class="p">():</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'consumer:'</span><span class="p">,</span> <span class="s">'get'</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
        <span class="n">queue</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>

<span class="n">t1</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">producer</span><span class="p">)</span>
<span class="n">t2</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">consumer</span><span class="p">)</span>

<span class="n">t1</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="n">t2</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</code></pre></div></div>

<blockquote>
  <p><del>è¾“å‡º</del></p>
  <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>producer: put 47
consumer: get 47
producer: put 71
consumer: get 71
producer: put 99
consumer: get 99
producer: put 30
consumer: get 30
producer: put 75
consumer: get 75
</code></pre></div>  </div>
</blockquote>

<hr />
<p>1.åå°çº¿ç¨‹: åå°çº¿ç¨‹åœ¨ä¸»çº¿ç¨‹åœæ­¢åå°±ç›´æ¥åœæ­¢è¿è¡Œã€‚ä»–ä»¬èµ„æºï¼ˆå¦‚æ‰“å¼€çš„æ–‡ä»¶ï¼Œæ•°æ®åº“äº‹åŠ¡ç­‰ï¼‰å¯èƒ½ä¸ä¼šè¢«æ­£ç¡®çš„é‡Šæ”¾ã€‚å¦‚æœä½ æƒ³è¦ä½ çš„çº¿ç¨‹ä¼˜ç¾çš„åœæ­¢ï¼Œè®©ä»–ä»¬ä¸è¦å˜ä¸ºåå°å’Œä½¿ç”¨ä¸€ä¸ªåˆé€‚çš„ä¿¡å·æœºåˆ¶å¦‚äº‹ä»¶<code class="highlighter-rouge">Event</code></p>

<p>2.nvoke: å®˜æ–¹æ–‡æ¡£ä¸­ä½¿ç”¨invokeä¸€è¯ï¼Œæˆ‘å¹¶æ²¡æœ‰æ›´å¥½çš„ç¿»è¯‘ï¼Œå› ä¸ºå…¶å®ƒè¯­è¨€ä¸­invokeåå°„æ˜¯ä¸€ç§æŠ€æœ¯æ‰‹æ®µï¼Œä½†Googleçš„ç¿»è¯‘ä¸­ï¼Œå°†æ­¤è§£é‡Šä¸ºè°ƒç”¨ <em>ï¼ˆæ˜¯æˆ‘æƒ³å¤šäº†ï¼‰</em></p>

<p>3.åŠ å…¥çº¿ç¨‹: åŠ å…¥çº¿ç¨‹ï¼Ÿä¸ç†è§£å¦‚ä½•èƒ½åŠ å…¥çº¿ç¨‹ï¼Œå¹¶ä¸”å®˜æ–¹æ–‡æ¡£è¯´ä¼šæ­»é”ã€‚å®æµ‹ï¼Œåˆ›å»º2ä¸ªçº¿ç¨‹äº’ç›¸join()ï¼Œè™½ç„¶é™·å…¥æ­»å¾ªç¯ï¼Œä½†å¹¶æ²¡æŠ›å‡ºé”™è¯¯    // TODO: ä¸çŸ¥ç†è§£æœ‰åå·®æ²¡æœ‰</p>

<p>4.æ­»é”: å¤šä¸ªå¯¹è±¡ï¼Œäº’æŒå¯¹æ–¹æ‰€éœ€èµ„æºçš„é”ï¼Œå¯¼è‡´éƒ½æ— æ³•è®¿é—®</p>

<p>5.blocking: é”çš„acquire()æ–¹æ³•çš„å‚æ•°ï¼Œæœ‰ç‚¹éš¾ç†è§£ï¼Œæ–‡ä¸­æ‰€å†™æ˜¯ç»“åˆå®˜æ–¹æ–‡æ¡£å’Œå®æµ‹çš„ç»“æœæè¿°æ‰€å¾—ã€‚ä¸è¿‡ä¸€èˆ¬ï¼Œæˆ‘ä»¬éƒ½ä¸ç”¨æ”¹å˜å®ƒçš„é»˜è®¤å€¼    // TODO: æ²¡æœ‰ä»æºç åˆ†æï¼ˆæ‰¾ä¸åˆ°æºç ï¼‰</p>

<p>6.å‚è€ƒä¹¦ç±ï¼šã€ŠPythonå¹¶è¡Œç¼–ç¨‹æ‰‹å†Œã€‹</p>

:ET